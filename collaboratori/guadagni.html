<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guadagni — CDM86 Collaboratori</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/assets/js/config.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: #f1f5f9; min-height: 100vh; }
        /* Sidebar */
        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 240px; background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); color: white; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-logo { padding: 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .sidebar-logo .brand { display: flex; align-items: center; gap: 10px; font-size: 1.1rem; font-weight: 800; }
        .sidebar-logo .brand i { color: #fbbf24; }
        .sidebar-logo .subtitle { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }
        nav { flex: 1; padding: 20px 12px; }
        nav a { display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: 10px; color: #94a3b8; text-decoration: none; font-size: 0.9rem; font-weight: 500; margin-bottom: 4px; transition: all 0.2s; }
        nav a:hover { background: rgba(255,255,255,0.08); color: white; }
        nav a.active { background: rgba(251,191,36,0.15); color: #fbbf24; }
        nav a i { width: 18px; text-align: center; }
        .sidebar-user { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.08); font-size: 0.85rem; }
        .sidebar-user .name { font-weight: 700; color: white; }
        .sidebar-user .email { color: #94a3b8; font-size: 0.75rem; margin-top: 2px; }
        .sidebar-user .logout { display: inline-flex; align-items: center; gap: 6px; color: #64748b; font-size: 0.75rem; cursor: pointer; margin-top: 8px; transition: color 0.2s; }
        .sidebar-user .logout:hover { color: #ef4444; }
        /* Main */
        .main { margin-left: 240px; padding: 28px 32px; }
        .page-header { margin-bottom: 24px; }
        .page-header h1 { font-size: 1.6rem; font-weight: 800; color: #0f172a; }
        .page-header p { color: #64748b; margin-top: 4px; }
        /* Summary */
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .sum-card { background: white; border-radius: 14px; padding: 20px; box-shadow: 0 1px 6px rgba(0,0,0,0.06); }
        .sum-card .icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-bottom: 12px; }
        .sum-card .val { font-size: 1.5rem; font-weight: 800; color: #0f172a; }
        .sum-card .lbl { font-size: 0.78rem; color: #64748b; margin-top: 4px; }
        .icon-green { background: #f0fdf4; color: #16a34a; }
        .icon-blue  { background: #eff6ff; color: #3b82f6; }
        .icon-gray  { background: #f8fafc; color: #64748b; }
        .icon-yellow{ background: #fefce8; color: #ca8a04; }
        /* Payout bar */
        .payout-banner {
            background: linear-gradient(135deg, #0f172a, #1e3a5f);
            border-radius: 16px; padding: 22px 28px; margin-bottom: 24px; color: white;
        }
        .payout-banner h3 { font-size: 1rem; opacity: 0.8; margin-bottom: 10px; }
        .pb-bar { background: rgba(255,255,255,0.15); border-radius: 50px; height: 10px; overflow: hidden; margin-bottom: 8px; }
        .pb-fill { height: 100%; background: linear-gradient(90deg, #22c55e, #86efac); border-radius: 50px; transition: width 0.6s; }
        .pb-labels { display: flex; justify-content: space-between; font-size: 0.8rem; opacity: 0.8; }
        .pb-labels .highlight { color: #fbbf24; font-weight: 700; opacity: 1; }
        /* Filters + table */
        .table-wrap { background: white; border-radius: 16px; box-shadow: 0 1px 6px rgba(0,0,0,0.07); overflow: hidden; }
        .table-top { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .table-top h3 { font-weight: 700; color: #0f172a; margin-right: auto; }
        .filter-select { padding: 8px 14px; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; background: white; cursor: pointer; outline: none; }
        .filter-select:focus { border-color: #0f172a; }
        table { width: 100%; border-collapse: collapse; }
        thead th { padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; background: #f8fafc; border-bottom: 1px solid #f1f5f9; }
        tbody tr { border-bottom: 1px solid #f1f5f9; transition: background 0.15s; }
        tbody tr:hover { background: #f8fafc; }
        tbody tr:last-child { border-bottom: none; }
        td { padding: 12px 16px; font-size: 0.875rem; color: #374151; }
        .badge-level { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .l1 { background: #dcfce7; color: #16a34a; }
        .l2 { background: #dbeafe; color: #2563eb; }
        .l3 { background: #fef3c7; color: #d97706; }
        .status-credited { background: #eff6ff; color: #2563eb; padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-paid { background: #f0fdf4; color: #16a34a; padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-cancelled { background: #fef2f2; color: #dc2626; padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .empty { text-align: center; padding: 48px; color: #94a3b8; }
        .empty i { font-size: 2.5rem; display: block; margin-bottom: 12px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-logo">
        <div class="brand"><i class="fas fa-handshake"></i> CDM86</div>
        <div class="subtitle">Pannello Collaboratori</div>
    </div>
    <nav>
        <a href="/collaboratori/dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
        <a href="/collaboratori/rete.html"><i class="fas fa-sitemap"></i> La mia rete</a>
        <a href="/collaboratori/guadagni.html" class="active"><i class="fas fa-euro-sign"></i> Guadagni</a>
        <a href="/collaboratori/profilo.html"><i class="fas fa-user-circle"></i> Profilo</a>
    </nav>
    <div class="sidebar-user">
        <div class="name" id="sidebarName">—</div>
        <div class="email" id="sidebarEmail">—</div>
        <div class="logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Esci</div>
    </div>
</div>

<div class="main">
    <div class="page-header">
        <h1><i class="fas fa-euro-sign" style="color:#16a34a; margin-right:10px;"></i>I miei guadagni</h1>
        <p>Storico completo di tutti i tuoi compensi</p>
    </div>

    <div class="summary-grid">
        <div class="sum-card">
            <div class="icon icon-green"><i class="fas fa-euro-sign"></i></div>
            <div class="val" id="statTotal">€0,00</div>
            <div class="lbl">Totale maturato</div>
        </div>
        <div class="sum-card">
            <div class="icon icon-blue"><i class="fas fa-hourglass-half"></i></div>
            <div class="val" id="statPending">€0,00</div>
            <div class="lbl">In attesa pagamento</div>
        </div>
        <div class="sum-card">
            <div class="icon icon-gray"><i class="fas fa-check-circle"></i></div>
            <div class="val" id="statPaid">€0,00</div>
            <div class="lbl">Già pagato</div>
        </div>
        <div class="sum-card">
            <div class="icon icon-yellow"><i class="fas fa-gift"></i></div>
            <div class="val" id="statBonus">€0,00</div>
            <div class="lbl">Bonus ricevuti</div>
        </div>
    </div>

    <!-- Payout progress -->
    <div class="payout-banner">
        <h3><i class="fas fa-wallet"></i> &nbsp;Progressione verso il pagamento</h3>
        <div class="pb-bar"><div class="pb-fill" id="pbFill" style="width:0%"></div></div>
        <div class="pb-labels">
            <span class="highlight" id="pbAmount">€0,00 maturati</span>
            <span id="pbThreshold">Soglia: €50,00</span>
        </div>
    </div>

    <!-- Table -->
    <div class="table-wrap">
        <div class="table-top">
            <h3>Dettaglio movimenti</h3>
            <select class="filter-select" id="filterStatus" onchange="renderTable()">
                <option value="">Tutti gli stati</option>
                <option value="credited">In attesa</option>
                <option value="paid">Pagati</option>
                <option value="cancelled">Annullati</option>
            </select>
            <select class="filter-select" id="filterLevel" onchange="renderTable()">
                <option value="">Tutti i livelli</option>
                <option value="1">Livello 1</option>
                <option value="2">Livello 2</option>
                <option value="3">Livello 3</option>
            </select>
            <select class="filter-select" id="filterType" onchange="renderTable()">
                <option value="">Tutti i tipi</option>
                <option value="user">Utenti</option>
                <option value="azienda">Aziende</option>
                <option value="associazione">Associazioni</option>
            </select>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Membro iscritto</th>
                    <th>Tipo</th>
                    <th>Livello</th>
                    <th>Importo base</th>
                    <th>Bonus</th>
                    <th>Totale</th>
                    <th>Stato</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody id="earningsTable">
                <tr><td colspan="8" style="text-align:center; padding:36px; color:#94a3b8;"><i class="fas fa-spinner fa-spin"></i> Caricamento...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let supabase_client, allEarnings = [];

    window.addEventListener('DOMContentLoaded', async () => {
        supabase_client = supabase.createClient(CDM86_CONFIG.supabase.url, CDM86_CONFIG.supabase.anonKey);
        const { data: { session } } = await supabase_client.auth.getSession();
        if (!session) { window.location.href = '/collaboratori/login.html'; return; }

        const { data: user } = await supabase_client.from('users').select('*').eq('id', session.user.id).single();
        if (!user?.is_collaborator || user.collaborator_status !== 'active') {
            window.location.href = '/collaboratori/login.html'; return;
        }
        document.getElementById('sidebarName').textContent  = `${user.first_name} ${user.last_name}`;
        document.getElementById('sidebarEmail').textContent = user.email;

        // Carica earnings
        const { data: earnings } = await supabase_client
            .from('collaborator_earnings')
            .select('*, new_user:new_user_id(first_name, last_name)')
            .eq('collaborator_id', user.id)
            .order('created_at', { ascending: false });

        allEarnings = earnings || [];

        // Summary
        const { data: summary } = await supabase_client
            .from('collaborator_earnings_summary')
            .select('*').eq('collaborator_id', user.id).maybeSingle();

        const { data: settings } = await supabase_client
            .from('collaborator_settings').select('payout_threshold').single();

        if (summary) {
            document.getElementById('statTotal').textContent   = fmt(summary.total_earned || 0);
            document.getElementById('statPending').textContent = fmt(summary.total_pending || 0);
            document.getElementById('statPaid').textContent    = fmt(summary.total_paid || 0);
            const bonus = allEarnings.reduce((s, e) => s + parseFloat(e.bonus_amount || 0), 0);
            document.getElementById('statBonus').textContent   = fmt(bonus);

            const threshold = settings?.payout_threshold || 50;
            const pending   = parseFloat(summary.total_pending || 0);
            const pct       = Math.min(100, (pending / threshold) * 100).toFixed(0);
            document.getElementById('pbFill').style.width      = pct + '%';
            document.getElementById('pbAmount').textContent    = `${fmt(pending)} maturati`;
            document.getElementById('pbThreshold').textContent = `Soglia: ${fmt(threshold)}`;
        }

        renderTable();
    });

    function renderTable() {
        const statusF = document.getElementById('filterStatus').value;
        const levelF  = document.getElementById('filterLevel').value;
        const typeF   = document.getElementById('filterType').value;

        let rows = allEarnings;
        if (statusF) rows = rows.filter(r => r.status === statusF);
        if (levelF)  rows = rows.filter(r => r.mlm_level === parseInt(levelF));
        if (typeF)   rows = rows.filter(r => r.registration_type === typeF);

        const tbody = document.getElementById('earningsTable');
        if (rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8"><div class="empty"><i class="fas fa-receipt"></i>Nessun movimento trovato</div></td></tr>`;
            return;
        }

        const typeLabels = { user: 'Utente', azienda: 'Azienda', associazione: 'Associazione' };
        const statusHtml = {
            credited:  '<span class="status-credited">In attesa</span>',
            paid:      '<span class="status-paid">Pagato</span>',
            cancelled: '<span class="status-cancelled">Annullato</span>'
        };

        tbody.innerHTML = rows.map(r => {
            const name = r.new_user ? `${r.new_user.first_name} ${r.new_user.last_name}` : '—';
            const date = new Date(r.created_at).toLocaleDateString('it-IT');
            const bonus = parseFloat(r.bonus_amount || 0);
            return `<tr>
                <td style="font-weight:600;color:#0f172a;">${name}</td>
                <td>${typeLabels[r.registration_type] || r.registration_type}</td>
                <td><span class="badge-level l${r.mlm_level}">L${r.mlm_level}</span></td>
                <td>€${parseFloat(r.base_amount).toFixed(2)}</td>
                <td>${bonus > 0 ? `<span style="color:#ca8a04;font-weight:600;">+€${bonus.toFixed(2)}</span>` : '—'}</td>
                <td style="font-weight:700;color:#16a34a;">€${parseFloat(r.total_amount).toFixed(2)}</td>
                <td>${statusHtml[r.status] || r.status}</td>
                <td style="color:#94a3b8;">${date}</td>
            </tr>`;
        }).join('');
    }

    function fmt(n) { return '€' + parseFloat(n).toFixed(2).replace('.', ','); }

    async function logout() {
        await supabase_client.auth.signOut();
        window.location.href = '/collaboratori/login.html';
    }
</script>
</body>
</html>
