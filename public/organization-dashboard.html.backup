<!DOCTYPE html><!DOCTYPE html>

<html lang="it"><html lang="it">

<head><head>

    <meta charset="UTF-8">    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>CDM86 - Pannello Azienda</title>    <title>CDM86 - Dashboard Organizzazione</title>

        

    <!-- Font Awesome -->    <!-- Font Awesome -->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        

    <style>    <style>

        * {        * {

            margin: 0;            margin: 0;

            padding: 0;            padding: 0;

            box-sizing: border-box;            box-sizing: border-box;

        }        }

                

        body {        body {

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);            background: #f5f7fa;

            min-height: 100vh;            min-height: 100vh;

            padding: 20px;        }

        }        

                /* Navbar */

        /* Top Bar */        .top-nav {

        .top-bar {            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            background: rgba(255,255,255,0.95);            color: white;

            backdrop-filter: blur(10px);            padding: 16px 20px;

            padding: 15px 30px;            box-shadow: 0 2px 10px rgba(0,0,0,0.1);

            border-radius: 15px;            position: sticky;

            margin-bottom: 30px;            top: 0;

            box-shadow: 0 4px 20px rgba(0,0,0,0.1);            z-index: 100;

            display: flex;            display: flex;

            justify-content: space-between;            justify-content: space-between;

            align-items: center;            align-items: center;

        }        }

                

        .logo-section {        .nav-brand {

            display: flex;            font-size: 24px;

            align-items: center;            font-weight: 800;

            gap: 15px;        }

        }        

                .nav-actions {

        .logo-icon {            display: flex;

            font-size: 32px;            gap: 15px;

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);            align-items: center;

            -webkit-background-clip: text;        }

            -webkit-text-fill-color: transparent;        

        }        .nav-btn {

                    background: rgba(255,255,255,0.2);

        .logo-text h1 {            border: none;

            font-size: 24px;            color: white;

            color: #2d3748;            padding: 10px 20px;

        }            border-radius: 8px;

                    cursor: pointer;

        .logo-text p {            transition: all 0.3s;

            font-size: 13px;            font-size: 14px;

            color: #718096;            font-weight: 600;

            margin-top: 2px;        }

        }        

                .nav-btn:hover {

        .user-section {            background: rgba(255,255,255,0.3);

            display: flex;        }

            align-items: center;        

            gap: 20px;        /* Container */

        }        .container {

                    max-width: 1200px;

        .org-badge {            margin: 30px auto;

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);            padding: 0 20px;

            color: white;        }

            padding: 8px 20px;        

            border-radius: 20px;        /* Cards */

            font-weight: 600;        .card {

            display: flex;            background: white;

            align-items: center;            border-radius: 16px;

            gap: 8px;            padding: 30px;

        }            margin-bottom: 25px;

                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);

        .logout-btn {        }

            background: #ef4444;        

            color: white;        .card h2 {

            border: none;            color: #667eea;

            padding: 10px 20px;            font-size: 24px;

            border-radius: 10px;            margin-bottom: 20px;

            cursor: pointer;            display: flex;

            font-weight: 600;            align-items: center;

            transition: all 0.3s;            gap: 10px;

        }        }

                

        .logout-btn:hover {        .card h3 {

            background: #dc2626;            color: #333;

            transform: translateY(-2px);            font-size: 18px;

        }            margin-bottom: 15px;

                }

        /* Main Container */        

        .container {        /* Stats Grid */

            max-width: 1400px;        .stats-grid {

            margin: 0 auto;            display: grid;

        }            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));

                    gap: 20px;

        /* Stats Grid */            margin-bottom: 30px;

        .stats-grid {        }

            display: grid;        

            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));        .stat-card {

            gap: 20px;            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            margin-bottom: 30px;            color: white;

        }            padding: 25px;

                    border-radius: 12px;

        .stat-card {            text-align: center;

            background: white;        }

            padding: 25px;        

            border-radius: 15px;        .stat-value {

            box-shadow: 0 4px 15px rgba(0,0,0,0.08);            font-size: 36px;

            transition: all 0.3s;            font-weight: 800;

            position: relative;            margin-bottom: 8px;

            overflow: hidden;        }

        }        

                .stat-label {

        .stat-card::before {            font-size: 14px;

            content: '';            opacity: 0.9;

            position: absolute;        }

            top: 0;        

            left: 0;        /* Organization Info */

            right: 0;        .org-info {

            height: 4px;            display: grid;

            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));

        }            gap: 20px;

                    margin-bottom: 30px;

        .stat-card:hover {        }

            transform: translateY(-5px);        

            box-shadow: 0 8px 25px rgba(0,0,0,0.12);        .info-item {

        }            display: flex;

                    align-items: flex-start;

        .stat-icon {            gap: 12px;

            font-size: 36px;        }

            margin-bottom: 15px;        

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);        .info-icon {

            -webkit-background-clip: text;            color: #667eea;

            -webkit-text-fill-color: transparent;            font-size: 20px;

        }            margin-top: 2px;

                }

        .stat-label {        

            font-size: 13px;        .info-content {

            color: #718096;            flex: 1;

            text-transform: uppercase;        }

            font-weight: 600;        

            letter-spacing: 0.5px;        .info-label {

            margin-bottom: 8px;            font-size: 12px;

        }            color: #999;

                    margin-bottom: 4px;

        .stat-value {        }

            font-size: 32px;        

            font-weight: 800;        .info-value {

            color: #2d3748;            font-size: 16px;

        }            color: #333;

                    font-weight: 600;

        .stat-change {        }

            font-size: 12px;        

            margin-top: 8px;        /* Referral Section */

            display: flex;        .referral-code-box {

            align-items: center;            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);

            gap: 5px;            padding: 25px;

        }            border-radius: 12px;

                    text-align: center;

        .stat-change.positive {            margin-bottom: 25px;

            color: #10b981;        }

        }        

                .referral-code-large {

        .stat-change.negative {            font-size: 42px;

            color: #ef4444;            font-weight: 800;

        }            color: #667eea;

                    letter-spacing: 4px;

        /* Referral Codes Section */            margin: 15px 0;

        .referral-section {        }

            background: white;        

            padding: 30px;        .copy-btn {

            border-radius: 15px;            background: #667eea;

            box-shadow: 0 4px 15px rgba(0,0,0,0.08);            color: white;

            margin-bottom: 30px;            border: none;

        }            padding: 12px 30px;

                    border-radius: 8px;

        .section-header {            cursor: pointer;

            display: flex;            font-size: 14px;

            justify-content: space-between;            font-weight: 600;

            align-items: center;            margin-top: 10px;

            margin-bottom: 25px;            transition: all 0.3s;

        }        }

                

        .section-title {        .copy-btn:hover {

            font-size: 20px;            background: #5568d3;

            font-weight: 700;            transform: translateY(-2px);

            color: #2d3748;        }

            display: flex;        

            align-items: center;        /* QR Code */

            gap: 10px;        .qr-container {

        }            text-align: center;

                    padding: 25px;

        .section-title i {            background: #f9f9f9;

            color: #667eea;            border-radius: 12px;

        }        }

                

        .codes-grid {        #qr-canvas {

            display: grid;            display: inline-block;

            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));            padding: 15px;

            gap: 20px;            background: white;

        }            border-radius: 8px;

                }

        .code-card {        

            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);        /* Employees List */

            padding: 25px;        .employees-list {

            border-radius: 12px;            list-style: none;

            border: 2px dashed #cbd5e0;        }

            position: relative;        

        }        .employee-item {

                    display: flex;

        .code-type {            justify-content: space-between;

            font-size: 12px;            align-items: center;

            text-transform: uppercase;            padding: 18px;

            font-weight: 700;            background: #f9f9f9;

            letter-spacing: 1px;            border-radius: 12px;

            margin-bottom: 10px;            margin-bottom: 12px;

            display: flex;            transition: all 0.3s;

            align-items: center;        }

            gap: 8px;        

        }        .employee-item:hover {

                    background: #f0f0f0;

        .code-type.employee {            transform: translateX(5px);

            color: #667eea;        }

        }        

                .employee-info {

        .code-type.external {            display: flex;

            color: #f59e0b;            align-items: center;

        }            gap: 15px;

                }

        .code-value {        

            font-size: 28px;        .employee-avatar {

            font-weight: 800;            width: 50px;

            color: #2d3748;            height: 50px;

            font-family: 'Courier New', monospace;            border-radius: 50%;

            margin-bottom: 15px;            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            display: flex;            color: white;

            align-items: center;            display: flex;

            gap: 15px;            align-items: center;

        }            justify-content: center;

                    font-weight: 600;

        .copy-btn {            font-size: 18px;

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);        }

            color: white;        

            border: none;        .employee-details {

            padding: 8px 16px;            flex: 1;

            border-radius: 8px;        }

            cursor: pointer;        

            font-weight: 600;        .employee-name {

            font-size: 13px;            font-weight: 600;

            transition: all 0.3s;            color: #333;

            display: flex;            margin-bottom: 4px;

            align-items: center;        }

            gap: 8px;        

        }        .employee-email {

                    font-size: 14px;

        .copy-btn:hover {            color: #999;

            transform: scale(1.05);        }

            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);        

        }        .employee-date {

                    font-size: 12px;

        .code-description {            color: #999;

            font-size: 13px;        }

            color: #718096;        

            line-height: 1.6;        .empty-state {

        }            text-align: center;

                    padding: 60px 20px;

        /* Tabs */            color: #999;

        .tabs-container {        }

            background: white;        

            border-radius: 15px;        .empty-state i {

            box-shadow: 0 4px 15px rgba(0,0,0,0.08);            font-size: 64px;

            overflow: hidden;            margin-bottom: 20px;

        }            opacity: 0.3;

                }

        .tabs-header {        

            display: flex;        /* Loading */

            background: #f7fafc;        .loading {

            border-bottom: 2px solid #e2e8f0;            text-align: center;

        }            padding: 60px;

                }

        .tab-btn {        

            flex: 1;        .spinner {

            padding: 18px 25px;            border: 4px solid #f3f3f3;

            background: none;            border-top: 4px solid #667eea;

            border: none;            border-radius: 50%;

            font-weight: 600;            width: 50px;

            color: #718096;            height: 50px;

            cursor: pointer;            animation: spin 1s linear infinite;

            transition: all 0.3s;            margin: 0 auto 20px;

            position: relative;        }

            display: flex;        

            align-items: center;        @keyframes spin {

            justify-content: center;            0% { transform: rotate(0deg); }

            gap: 10px;            100% { transform: rotate(360deg); }

        }        }

                

        .tab-btn i {        /* Utility Classes */

            font-size: 18px;        .hidden {

        }            display: none !important;

                }

        .tab-btn.active {        

            color: #667eea;        .qr-title {

            background: white;            text-align: center;

        }            margin-top: 30px;

                    margin-bottom: 20px;

        .tab-btn.active::after {        }

            content: '';        

            position: absolute;        .qr-subtitle {

            bottom: 0;            margin-top: 15px;

            left: 0;            color: #666;

            right: 0;        }

            height: 3px;        

            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);        .margin-top-10 {

        }            margin-top: 10px;

                }

        .tab-badge {        

            background: #667eea;        /* Responsive */

            color: white;        @media (max-width: 768px) {

            padding: 3px 10px;            .stats-grid {

            border-radius: 12px;                grid-template-columns: 1fr;

            font-size: 12px;            }

            font-weight: 700;            

        }            .org-info {

                        grid-template-columns: 1fr;

        .tab-content {            }

            display: none;            

            padding: 30px;            .referral-code-large {

        }                font-size: 32px;

                    }

        .tab-content.active {        }

            display: block;    </style>

            animation: fadeIn 0.3s ease-in;</head>

        }<body>

            <!-- Top Navigation -->

        @keyframes fadeIn {    <nav class="top-nav">

            from { opacity: 0; transform: translateY(10px); }        <div class="nav-brand">

            to { opacity: 1; transform: translateY(0); }            üè¢ CDM86 - Dashboard Organizzazione

        }        </div>

                <div class="nav-actions">

        /* User Cards */            <button class="nav-btn" onclick="logout()">

        .users-grid {                <i class="fas fa-sign-out-alt"></i> Logout

            display: grid;            </button>

            gap: 15px;        </div>

        }    </nav>

            

        .user-card {    <div class="container">

            background: #f7fafc;        <div id="loading" class="loading">

            padding: 20px;            <div class="spinner"></div>

            border-radius: 12px;            <p>Caricamento dashboard...</p>

            display: flex;        </div>

            align-items: center;        

            justify-content: space-between;        <div id="dashboard" class="hidden">

            transition: all 0.3s;            <!-- Organization Info Card -->

            border-left: 4px solid transparent;            <div class="card">

        }                <h2><i class="fas fa-building"></i> Informazioni Organizzazione</h2>

                        <div class="org-info" id="org-info">

        .user-card:hover {                    <!-- Populated by JS -->

            background: white;                </div>

            box-shadow: 0 4px 15px rgba(0,0,0,0.08);            </div>

            border-left-color: #667eea;            

        }            <!-- Stats -->

                    <div class="stats-grid">

        .user-info {                <div class="stat-card">

            display: flex;                    <div class="stat-value" id="employees-count">0</div>

            align-items: center;                    <div class="stat-label">Dipendenti/Membri</div>

            gap: 15px;                </div>

        }                <div class="stat-card">

                            <div class="stat-value" id="points-count">0</div>

        .user-avatar {                    <div class="stat-label">Punti Totali</div>

            width: 50px;                </div>

            height: 50px;            </div>

            border-radius: 50%;            

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);            <!-- Referral Code -->

            display: flex;            <div class="card">

            align-items: center;                <h2><i class="fas fa-qrcode"></i> Codice Referral</h2>

            justify-content: center;                <div class="referral-code-box">

            color: white;                    <p>Condividi questo codice con i tuoi dipendenti/membri</p>

            font-weight: 700;                    <div class="referral-code-large" id="referral-code">ORG0000</div>

            font-size: 18px;                    <button class="copy-btn" onclick="copyReferralCode()">

        }                        <i class="fas fa-copy"></i> Copia Codice

                            </button>

        .user-details h4 {                </div>

            font-size: 16px;                

            color: #2d3748;                <h3 class="qr-title">QR Code per Registrazione</h3>

            margin-bottom: 4px;                <div class="qr-container">

        }                    <div id="qr-canvas"></div>

                            <p class="qr-subtitle">Scansiona per registrarti automaticamente</p>

        .user-details p {                </div>

            font-size: 13px;            </div>

            color: #718096;            

        }            <!-- Employees List -->

                    <div class="card">

        .user-meta {                <h2><i class="fas fa-users"></i> Dipendenti/Membri Registrati</h2>

            display: flex;                <ul class="employees-list" id="employees-list">

            align-items: center;                    <!-- Populated by JS -->

            gap: 20px;                </ul>

        }            </div>

                </div>

        .user-points {    </div>

            text-align: right;    

        }    <!-- QRCode.js Library -->

            <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

        .points-value {    

            font-size: 20px;    <script type="module">

            font-weight: 700;        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

            color: #667eea;        

        }        const supabaseUrl = 'https://uchrjlngfzfibcpdxtky.supabase.co';

                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjaHJqbG5nZnpmaWJjcGR4dGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMzEyMDYsImV4cCI6MjA3NTYwNzIwNn0.64JK3OhYJi2YtrErctNAp_sCcSHwB656NVLdooyceOM';

        .points-label {        const supabase = createClient(supabaseUrl, supabaseKey);

            font-size: 11px;        

            color: #718096;        let currentOrg = null;

            text-transform: uppercase;        

        }        // Make functions global

                window.logout = logout;

        .user-status {        window.copyReferralCode = copyReferralCode;

            padding: 6px 14px;        

            border-radius: 20px;        // Check authentication and load data

            font-size: 12px;        async function init() {

            font-weight: 600;            try {

        }                const { data: { session } } = await supabase.auth.getSession();

                        

        .status-active {                if (!session) {

            background: #d1fae5;                    window.location.href = '/index.html';

            color: #065f46;                    return;

        }                }

                        

        .status-inactive {                // Get organization data

            background: #fee2e2;                const { data: orgData, error: orgError } = await supabase

            color: #991b1b;                    .from('organizations')

        }                    .select('*')

                            .eq('id', session.user.id)

        /* Benefits Section */                    .single();

        .benefits-grid {                

            display: grid;                if (orgError || !orgData) {

            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));                    alert('Errore: account organizzazione non trovato');

            gap: 20px;                    window.location.href = '/index.html';

        }                    return;

                        }

        .benefit-card {                

            background: white;                currentOrg = orgData;

            border: 2px solid #e2e8f0;                

            border-radius: 12px;                // Load employees

            padding: 25px;                const { data: employees, error: empError } = await supabase

            transition: all 0.3s;                    .from('users')

            position: relative;                    .select('*')

        }                    .eq('organization_id', orgData.id)

                            .order('created_at', { ascending: false });

        .benefit-card:hover {                

            border-color: #667eea;                if (empError) {

            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);                    console.error('Error loading employees:', empError);

            transform: translateY(-5px);                }

        }                

                        // Display data

        .benefit-icon {                displayOrganizationInfo(orgData);

            font-size: 32px;                displayStats(orgData, employees || []);

            margin-bottom: 15px;                displayReferralCode(orgData.referral_code);

        }                generateQRCode(orgData.referral_code);

                        displayEmployees(employees || []);

        .benefit-title {                

            font-size: 18px;                // Show dashboard

            font-weight: 700;                document.getElementById('loading').style.display = 'none';

            color: #2d3748;                document.getElementById('dashboard').style.display = 'block';

            margin-bottom: 8px;                

        }            } catch (error) {

                        console.error('Init error:', error);

        .benefit-description {                alert('Errore durante il caricamento');

            font-size: 14px;            }

            color: #718096;        }

            line-height: 1.6;        

            margin-bottom: 15px;        function displayOrganizationInfo(org) {

        }            const typeLabel = org.organization_type === 'company' ? 'Azienda' : 'Associazione';

                    const typeIcon = org.organization_type === 'company' ? 'fa-building' : 'fa-hands-helping';

        .benefit-points {            

            font-size: 24px;            const html = `

            font-weight: 800;                <div class="info-item">

            color: #667eea;                    <i class="fas ${typeIcon} info-icon"></i>

            display: flex;                    <div class="info-content">

            align-items: center;                        <div class="info-label">Tipo</div>

            gap: 8px;                        <div class="info-value">${typeLabel}</div>

        }                    </div>

                        </div>

        .benefit-points i {                <div class="info-item">

            font-size: 18px;                    <i class="fas fa-signature info-icon"></i>

        }                    <div class="info-content">

                                <div class="info-label">Nome</div>

        .add-benefit-btn {                        <div class="info-value">${org.name}</div>

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);                    </div>

            color: white;                </div>

            border: none;                <div class="info-item">

            padding: 15px 30px;                    <i class="fas fa-envelope info-icon"></i>

            border-radius: 10px;                    <div class="info-content">

            cursor: pointer;                        <div class="info-label">Email</div>

            font-weight: 600;                        <div class="info-value">${org.email}</div>

            font-size: 16px;                    </div>

            display: flex;                </div>

            align-items: center;                ${org.vat_number ? `

            gap: 10px;                <div class="info-item">

            margin-bottom: 20px;                    <i class="fas fa-file-invoice info-icon"></i>

            transition: all 0.3s;                    <div class="info-content">

        }                        <div class="info-label">P.IVA</div>

                                <div class="info-value">${org.vat_number}</div>

        .add-benefit-btn:hover {                    </div>

            transform: translateY(-2px);                </div>

            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);                ` : ''}

        }                ${org.tax_code ? `

                        <div class="info-item">

        /* Empty State */                    <i class="fas fa-file-alt info-icon"></i>

        .empty-state {                    <div class="info-content">

            text-align: center;                        <div class="info-label">Codice Fiscale</div>

            padding: 60px 20px;                        <div class="info-value">${org.tax_code}</div>

            color: #718096;                    </div>

        }                </div>

                        ` : ''}

        .empty-state i {                ${org.city ? `

            font-size: 64px;                <div class="info-item">

            margin-bottom: 20px;                    <i class="fas fa-map-marker-alt info-icon"></i>

            opacity: 0.3;                    <div class="info-content">

        }                        <div class="info-label">Sede</div>

                                <div class="info-value">${org.city}${org.province ? ' (' + org.province + ')' : ''}</div>

        .empty-state h3 {                    </div>

            font-size: 20px;                </div>

            margin-bottom: 10px;                ` : ''}

            color: #2d3748;            `;

        }            

                    document.getElementById('org-info').innerHTML = html;

        .empty-state p {        }

            font-size: 14px;        

        }        function displayStats(org, employees) {

                    document.getElementById('employees-count').textContent = employees.length;

        /* Loading Spinner */            document.getElementById('points-count').textContent = org.points || 0;

        .loading {        }

            text-align: center;        

            padding: 40px;        function displayReferralCode(code) {

        }            document.getElementById('referral-code').textContent = code;

                }

        .spinner {        

            border: 4px solid #f3f4f6;        function generateQRCode(referralCode) {

            border-top: 4px solid #667eea;            const qrContainer = document.getElementById('qr-canvas');

            border-radius: 50%;            qrContainer.innerHTML = '';

            width: 50px;            

            height: 50px;            const referralUrl = `https://cdm86.com/index.html?ref=${referralCode}`;

            animation: spin 1s linear infinite;            

            margin: 0 auto;            if (typeof QRCode !== 'undefined') {

        }                new QRCode(qrContainer, {

                            text: referralUrl,

        @keyframes spin {                    width: 200,

            0% { transform: rotate(0deg); }                    height: 200,

            100% { transform: rotate(360deg); }                    colorDark: '#667eea',

        }                    colorLight: '#ffffff',

                            correctLevel: QRCode.CorrectLevel.H

        /* Responsive */                });

        @media (max-width: 768px) {            }

            body {        }

                padding: 10px;        

            }        function displayEmployees(employees) {

                        const list = document.getElementById('employees-list');

            .top-bar {            

                flex-direction: column;            if (employees.length === 0) {

                gap: 15px;                list.innerHTML = `

                padding: 15px;                    <div class="empty-state">

            }                        <i class="fas fa-users"></i>

                                    <p>Nessun dipendente/membro registrato ancora</p>

            .stats-grid {                        <p class="margin-top-10">Condividi il codice referral per iniziare!</p>

                grid-template-columns: 1fr;                    </div>

            }                `;

                            return;

            .codes-grid {            }

                grid-template-columns: 1fr;            

            }            const html = employees.map(emp => {

                            const initials = `${emp.first_name.charAt(0)}${emp.last_name.charAt(0)}`.toUpperCase();

            .tabs-header {                const joinDate = new Date(emp.created_at).toLocaleDateString('it-IT', {

                flex-direction: column;                    day: 'numeric',

            }                    month: 'short',

                                year: 'numeric'

            .user-card {                });

                flex-direction: column;                

                gap: 15px;                return `

            }                    <li class="employee-item">

                                    <div class="employee-info">

            .user-meta {                            <div class="employee-avatar">${initials}</div>

                width: 100%;                            <div class="employee-details">

                justify-content: space-between;                                <div class="employee-name">${emp.first_name} ${emp.last_name}</div>

            }                                <div class="employee-email">${emp.email}</div>

                                        </div>

            .code-value {                        </div>

                font-size: 20px;                        <div class="employee-date">

                flex-direction: column;                            Iscritto il ${joinDate}

                align-items: flex-start;                        </div>

            }                    </li>

        }                `;

    </style>            }).join('');

</head>            

<body>            list.innerHTML = html;

    <!-- Top Bar -->        }

    <div class="top-bar">        

        <div class="logo-section">        function copyReferralCode() {

            <i class="fas fa-building logo-icon"></i>            const code = document.getElementById('referral-code').textContent;

            <div class="logo-text">            navigator.clipboard.writeText(code).then(() => {

                <h1>Pannello Azienda</h1>                const btn = event.target.closest('.copy-btn');

                <p id="org-name">Caricamento...</p>                const originalText = btn.innerHTML;

            </div>                btn.innerHTML = '<i class="fas fa-check"></i> Copiato!';

        </div>                setTimeout(() => {

        <div class="user-section">                    btn.innerHTML = originalText;

            <div class="org-badge">                }, 2000);

                <i class="fas fa-shield-alt"></i>            });

                <span id="org-email">admin@azienda.com</span>        }

            </div>        

            <button class="logout-btn" onclick="logout()">        async function logout() {

                <i class="fas fa-sign-out-alt"></i> Esci            try {

            </button>                localStorage.clear();

        </div>                sessionStorage.clear();

    </div>                await supabase.auth.signOut({ scope: 'global' });

                window.location.replace('/index.html');

    <div class="container">            } catch (error) {

        <!-- Stats Grid -->                console.error('Logout error:', error);

        <div class="stats-grid">                localStorage.clear();

            <div class="stat-card">                sessionStorage.clear();

                <i class="fas fa-users stat-icon"></i>                window.location.replace('/index.html');

                <div class="stat-label">Dipendenti Totali</div>            }

                <div class="stat-value" id="total-employees">0</div>        }

                <div class="stat-change positive">        

                    <i class="fas fa-arrow-up"></i>        // Initialize

                    <span>Codice aziendale</span>        init();

                </div>    </script>

            </div></body>

            </html>

            <div class="stat-card">
                <i class="fas fa-user-friends stat-icon"></i>
                <div class="stat-label">Referral Esterni</div>
                <div class="stat-value" id="total-externals">0</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>Codice esterno</span>
                </div>
            </div>
            
            <div class="stat-card">
                <i class="fas fa-coins stat-icon"></i>
                <div class="stat-label">Punti Totali</div>
                <div class="stat-value" id="total-points">0</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>Punti accumulati</span>
                </div>
            </div>
            
            <div class="stat-card">
                <i class="fas fa-chart-line stat-icon"></i>
                <div class="stat-label">Utenti Attivi</div>
                <div class="stat-value" id="active-users">0</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>Verificati e attivi</span>
                </div>
            </div>
        </div>

        <!-- Referral Codes Section -->
        <div class="referral-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-qrcode"></i>
                    Codici Referral Azienda
                </h2>
            </div>
            
            <div class="codes-grid">
                <!-- Employee Code -->
                <div class="code-card">
                    <div class="code-type employee">
                        <i class="fas fa-briefcase"></i>
                        Codice Dipendenti
                    </div>
                    <div class="code-value">
                        <span id="employee-code">LOADING...</span>
                        <button class="copy-btn" onclick="copyCode('employee')">
                            <i class="fas fa-copy"></i>
                            Copia
                        </button>
                    </div>
                    <div class="code-description">
                        üëî Usa questo codice per invitare <strong>dipendenti</strong>. Avranno accesso ai benefit aziendali e supporto prioritario.
                    </div>
                </div>
                
                <!-- External Code -->
                <div class="code-card">
                    <div class="code-type external">
                        <i class="fas fa-globe"></i>
                        Codice Amici Esterni
                    </div>
                    <div class="code-value">
                        <span id="external-code">LOADING...</span>
                        <button class="copy-btn" onclick="copyCode('external')">
                            <i class="fas fa-copy"></i>
                            Copia
                        </button>
                    </div>
                    <div class="code-description">
                        üåç Usa questo codice per invitare <strong>amici/clienti esterni</strong>. Accumuleranno punti per l'azienda senza benefit.
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Container -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('employees')">
                    <i class="fas fa-user-tie"></i>
                    Dipendenti
                    <span class="tab-badge" id="employees-badge">0</span>
                </button>
                <button class="tab-btn" onclick="switchTab('externals')">
                    <i class="fas fa-users"></i>
                    Referral Esterni
                    <span class="tab-badge" id="externals-badge">0</span>
                </button>
                <button class="tab-btn" onclick="switchTab('benefits')">
                    <i class="fas fa-gift"></i>
                    Benefit Aziendali
                    <span class="tab-badge" id="benefits-badge">0</span>
                </button>
            </div>
            
            <!-- Employees Tab -->
            <div class="tab-content active" id="employees-tab">
                <div class="loading" id="employees-loading">
                    <div class="spinner"></div>
                    <p>Caricamento dipendenti...</p>
                </div>
                <div class="users-grid" id="employees-grid" style="display: none;">
                    <!-- Will be populated by JS -->
                </div>
                <div class="empty-state" id="employees-empty" style="display: none;">
                    <i class="fas fa-user-tie"></i>
                    <h3>Nessun dipendente ancora</h3>
                    <p>Condividi il codice dipendenti per iniziare!</p>
                </div>
            </div>
            
            <!-- Externals Tab -->
            <div class="tab-content" id="externals-tab">
                <div class="loading" id="externals-loading">
                    <div class="spinner"></div>
                    <p>Caricamento referral esterni...</p>
                </div>
                <div class="users-grid" id="externals-grid" style="display: none;">
                    <!-- Will be populated by JS -->
                </div>
                <div class="empty-state" id="externals-empty" style="display: none;">
                    <i class="fas fa-users"></i>
                    <h3>Nessun referral esterno</h3>
                    <p>Condividi il codice esterno per accumulare punti!</p>
                </div>
            </div>
            
            <!-- Benefits Tab -->
            <div class="tab-content" id="benefits-tab">
                <button class="add-benefit-btn" onclick="addBenefit()">
                    <i class="fas fa-plus-circle"></i>
                    Aggiungi Nuovo Benefit
                </button>
                
                <div class="loading" id="benefits-loading">
                    <div class="spinner"></div>
                    <p>Caricamento benefit...</p>
                </div>
                <div class="benefits-grid" id="benefits-grid" style="display: none;">
                    <!-- Will be populated by JS -->
                </div>
                <div class="empty-state" id="benefits-empty" style="display: none;">
                    <i class="fas fa-gift"></i>
                    <h3>Nessun benefit configurato</h3>
                    <p>Aggiungi benefit per premiare i tuoi dipendenti!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/assets/js/config.js"></script>
    
    <script>
        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        
        let currentOrganization = null;
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadOrganizationData();
            await loadAllData();
        });
        
        // Check authentication
        async function checkAuth() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            
            if (!user) {
                window.location.href = '/login.html';
                return;
            }
            
            console.log('‚úÖ User autenticato:', user.email);
            
            // Check if user is an organization
            const { data: org, error } = await supabaseClient
                .from('organizations')
                .select('*')
                .eq('email', user.email)
                .single();
            
            if (error) {
                console.error('‚ùå Errore caricamento org:', error);
            }
            
            if (!org) {
                alert('Accesso negato. Solo le aziende possono accedere a questa pagina.');
                window.location.href = '/dashboard.html';
                return;
            }
            
            console.log('‚úÖ Organizzazione trovata:', org);
            currentOrganization = org;
        }
        
        // Load organization data
        async function loadOrganizationData() {
            if (!currentOrganization) return;
            
            document.getElementById('org-name').textContent = currentOrganization.name;
            document.getElementById('org-email').textContent = currentOrganization.email;
            document.getElementById('employee-code').textContent = currentOrganization.referral_code || 'N/A';
            document.getElementById('external-code').textContent = currentOrganization.referral_code_external || 'N/A';
            
            console.log('üìä Codici:', {
                dipendenti: currentOrganization.referral_code,
                esterni: currentOrganization.referral_code_external
            });
        }
        
        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadEmployees(),
                loadExternals(),
                loadBenefits(),
                loadStats()
            ]);
        }
        
        // Load employees
        async function loadEmployees() {
            const loadingEl = document.getElementById('employees-loading');
            const gridEl = document.getElementById('employees-grid');
            const emptyEl = document.getElementById('employees-empty');
            
            try {
                console.log('üîç Cerco dipendenti per org:', currentOrganization.id);
                
                const { data: employees, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('organization_id', currentOrganization.id)
                    .eq('is_employee', true)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log('üëî Dipendenti trovati:', employees);
                
                loadingEl.style.display = 'none';
                
                if (!employees || employees.length === 0) {
                    emptyEl.style.display = 'block';
                    document.getElementById('employees-badge').textContent = '0';
                    return;
                }
                
                gridEl.style.display = 'grid';
                gridEl.innerHTML = employees.map(user => createUserCard(user, 'employee')).join('');
                document.getElementById('employees-badge').textContent = employees.length;
                
            } catch (error) {
                console.error('‚ùå Errore caricamento dipendenti:', error);
                loadingEl.innerHTML = '<p style="color: #ef4444;">Errore: ' + error.message + '</p>';
            }
        }
        
        // Load externals
        async function loadExternals() {
            const loadingEl = document.getElementById('externals-loading');
            const gridEl = document.getElementById('externals-grid');
            const emptyEl = document.getElementById('externals-empty');
            
            try {
                console.log('üîç Cerco referral esterni per org:', currentOrganization.id);
                
                const { data: externals, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('organization_id', currentOrganization.id)
                    .eq('referred_by_organization_external', true)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log('üåç Referral esterni trovati:', externals);
                
                loadingEl.style.display = 'none';
                
                if (!externals || externals.length === 0) {
                    emptyEl.style.display = 'block';
                    document.getElementById('externals-badge').textContent = '0';
                    return;
                }
                
                gridEl.style.display = 'grid';
                gridEl.innerHTML = externals.map(user => createUserCard(user, 'external')).join('');
                document.getElementById('externals-badge').textContent = externals.length;
                
            } catch (error) {
                console.error('‚ùå Errore caricamento esterni:', error);
                loadingEl.innerHTML = '<p style="color: #ef4444;">Errore: ' + error.message + '</p>';
            }
        }
        
        // Load benefits
        async function loadBenefits() {
            const loadingEl = document.getElementById('benefits-loading');
            const gridEl = document.getElementById('benefits-grid');
            const emptyEl = document.getElementById('benefits-empty');
            
            try {
                console.log('üîç Cerco benefit per org:', currentOrganization.id);
                
                const { data: benefits, error } = await supabaseClient
                    .from('organization_benefits')
                    .select('*')
                    .eq('organization_id', currentOrganization.id)
                    .eq('active', true)
                    .order('points_required', { ascending: true });
                
                if (error) throw error;
                
                console.log('üéÅ Benefit trovati:', benefits);
                
                loadingEl.style.display = 'none';
                
                if (!benefits || benefits.length === 0) {
                    emptyEl.style.display = 'block';
                    document.getElementById('benefits-badge').textContent = '0';
                    return;
                }
                
                gridEl.style.display = 'grid';
                gridEl.innerHTML = benefits.map(benefit => createBenefitCard(benefit)).join('');
                document.getElementById('benefits-badge').textContent = benefits.length;
                
            } catch (error) {
                console.error('‚ùå Errore caricamento benefit:', error);
                loadingEl.innerHTML = '<p style="color: #ef4444;">Errore: ' + error.message + '</p>';
            }
        }
        
        // Load stats
        async function loadStats() {
            try {
                console.log('üìä Calcolo statistiche...');
                
                // Count employees
                const { count: employeeCount } = await supabaseClient
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentOrganization.id)
                    .eq('is_employee', true);
                
                // Count externals
                const { count: externalCount } = await supabaseClient
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentOrganization.id)
                    .eq('referred_by_organization_external', true);
                
                // Count active users
                const { count: activeCount } = await supabaseClient
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .eq('organization_id', currentOrganization.id)
                    .eq('is_active', true);
                
                // Calculate total points
                const { data: users } = await supabaseClient
                    .from('users')
                    .select('points')
                    .eq('organization_id', currentOrganization.id);
                
                const totalPoints = users?.reduce((sum, user) => sum + (user.points || 0), 0) || 0;
                
                console.log('üìä Stats:', {
                    employees: employeeCount,
                    externals: externalCount,
                    active: activeCount,
                    points: totalPoints
                });
                
                document.getElementById('total-employees').textContent = employeeCount || 0;
                document.getElementById('total-externals').textContent = externalCount || 0;
                document.getElementById('total-points').textContent = totalPoints.toLocaleString();
                document.getElementById('active-users').textContent = activeCount || 0;
                
            } catch (error) {
                console.error('‚ùå Errore caricamento statistiche:', error);
            }
        }
        
        // Create user card HTML
        function createUserCard(user, type) {
            const initials = (user.first_name?.[0] || '') + (user.last_name?.[0] || '');
            const statusClass = user.is_active ? 'status-active' : 'status-inactive';
            const statusText = user.is_active ? 'Attivo' : 'Inattivo';
            const typeIcon = type === 'employee' ? 'üëî' : 'üåç';
            
            return `
                <div class="user-card">
                    <div class="user-info">
                        <div class="user-avatar">${initials || '?'}</div>
                        <div class="user-details">
                            <h4>${typeIcon} ${user.first_name || ''} ${user.last_name || ''}</h4>
                            <p>${user.email}</p>
                        </div>
                    </div>
                    <div class="user-meta">
                        <div class="user-points">
                            <div class="points-value">${user.points || 0}</div>
                            <div class="points-label">Punti</div>
                        </div>
                        <div class="user-status ${statusClass}">${statusText}</div>
                    </div>
                </div>
            `;
        }
        
        // Create benefit card HTML
        function createBenefitCard(benefit) {
            return `
                <div class="benefit-card">
                    <div class="benefit-icon">üéÅ</div>
                    <div class="benefit-title">${benefit.title}</div>
                    <div class="benefit-description">${benefit.description || ''}</div>
                    <div class="benefit-points">
                        <i class="fas fa-coins"></i>
                        ${benefit.points_required} punti
                    </div>
                </div>
            `;
        }
        
        // Switch tabs
        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        // Copy referral code
        function copyCode(type) {
            const code = type === 'employee' 
                ? document.getElementById('employee-code').textContent
                : document.getElementById('external-code').textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                alert(`‚úÖ Codice ${type === 'employee' ? 'dipendenti' : 'esterno'} copiato: ${code}`);
            });
        }
        
        // Add benefit (placeholder)
        async function addBenefit() {
            const title = prompt('Nome del benefit:');
            if (!title) return;
            
            const description = prompt('Descrizione:');
            const points = prompt('Punti richiesti:');
            
            if (!points || isNaN(points)) {
                alert('Punti non validi');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('organization_benefits')
                    .insert({
                        organization_id: currentOrganization.id,
                        title: title,
                        description: description,
                        points_required: parseInt(points),
                        active: true
                    });
                
                if (error) throw error;
                
                alert('‚úÖ Benefit aggiunto con successo!');
                await loadBenefits();
                
            } catch (error) {
                console.error('‚ùå Errore:', error);
                alert('Errore durante l\'aggiunta del benefit');
            }
        }
        
        // Logout
        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
