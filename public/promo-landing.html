<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Promozione - CDM86</title>
    <meta name="description" id="pageDescription" content="Scopri questa incredibile offerta su CDM86!">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" id="ogTitle" content="Promozione CDM86">
    <meta property="og:description" id="ogDescription" content="Scopri questa incredibile offerta!">
    <meta property="og:image" id="ogImage" content="">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" id="twitterTitle" content="Promozione CDM86">
    <meta property="twitter:description" id="twitterDescription" content="Scopri questa incredibile offerta!">
    <meta property="twitter:image" id="twitterImage" content="">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- QR Code generator (pure JS, no canvas deps) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="/assets/js/config.js"></script>
    
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd6;
            --accent: #fbbf24;
            --accent-dark: #f59e0b;
            --dark: #0f172a;
            --dark2: #1e293b;
            --muted: #64748b;
            --light: #f8fafc;
            --white: #ffffff;
            --radius: 1.25rem;
            --shadow: 0 25px 60px rgba(0,0,0,0.15);
            --shadow-sm: 0 4px 20px rgba(0,0,0,0.08);
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--light);
            color: var(--dark2);
            min-height: 100vh;
        }

        /* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #loadingScreen {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999; color: white;
            transition: opacity 0.4s;
        }
        #loadingScreen .spinner {
            width: 56px; height: 56px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1.5rem;
        }
        #loadingScreen p { font-size: 1.1rem; font-weight: 600; opacity: 0.9; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ Navbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .lp-nav {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.95);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.06);
            padding: 1rem 2rem;
            display: flex; align-items: center; justify-content: space-between;
        }
        .lp-nav-logo {
            display: flex; align-items: center; gap: 0.6rem;
            text-decoration: none;
            font-weight: 800; font-size: 1.2rem; color: var(--dark2);
        }
        .lp-nav-logo span {
            background: linear-gradient(135deg, var(--primary), #764ba2);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .lp-nav-back {
            display: flex; align-items: center; gap: 0.5rem;
            text-decoration: none; color: var(--muted);
            font-size: 0.9rem; font-weight: 500;
            transition: color 0.2s;
        }
        .lp-nav-back:hover { color: var(--primary); }

        /* â”€â”€ Org Landing (from landing builder) â”€â”€â”€ */
        #orgLandingWrap {
            display: none;
            font-family: 'Inter', sans-serif;
        }
        #orgLandingWrap * { font-family: inherit; }

        /* Enhance existing section styles injected by builder */
        #orgLandingWrap .section-hero {
            position: relative; overflow: hidden;
        }
        #orgLandingWrap .section-hero::before {
            content: '';
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.15);
            z-index: 1;
        }
        #orgLandingWrap .section-hero > * { position: relative; z-index: 2; }

        #orgLandingWrap .landing-social-bar {
            background: var(--dark2) !important;
            padding: 3rem 2rem !important;
        }
        #orgLandingWrap .landing-social-icons {
            display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;
        }
        #orgLandingWrap .landing-social-link {
            width: 52px; height: 52px;
            border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 1.3rem; color: white;
            text-decoration: none;
            transition: transform 0.25s, box-shadow 0.25s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        #orgLandingWrap .landing-social-link:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        /* â”€â”€ Promo Landing (standard promo card) â”€â”€ */
        #promoLandingWrap {
            display: none;
            max-width: 720px;
            margin: 2.5rem auto;
            padding: 0 1rem 4rem;
        }

        .pl-hero {
            border-radius: var(--radius);
            overflow: hidden;
            background: white;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        .pl-hero-image {
            width: 100%; height: 420px;
            object-fit: cover;
            display: block;
        }
        .pl-hero-image-placeholder {
            width: 100%; height: 420px;
            background: linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 50%, #818cf8 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 5rem;
        }
        .pl-hero-body { padding: 2.5rem; }
        .pl-badge {
            display: inline-flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: #1e3a8a;
            padding: 0.45rem 1.1rem;
            border-radius: 2rem;
            font-size: 0.8rem; font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            margin-bottom: 1.2rem;
        }
        .pl-title {
            font-size: 2.2rem; font-weight: 900;
            color: var(--dark); line-height: 1.2;
            margin-bottom: 1rem;
        }
        .pl-desc {
            font-size: 1.1rem; color: var(--muted);
            line-height: 1.7; margin-bottom: 1.8rem;
        }
        .pl-pricing {
            display: flex; align-items: baseline; gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .pl-price {
            font-size: 3.2rem; font-weight: 900;
            color: var(--primary); line-height: 1;
        }
        .pl-original {
            font-size: 1.4rem; color: #cbd5e1;
            text-decoration: line-through;
        }
        .pl-savings {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 2rem;
            font-size: 0.85rem; font-weight: 700;
            margin-bottom: 1.8rem;
        }
        .pl-cta-btn {
            display: block; width: 100%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: #1e3a8a;
            padding: 1.2rem 2rem;
            border-radius: 1rem;
            font-size: 1.15rem; font-weight: 800;
            border: none; cursor: pointer;
            text-align: center; text-decoration: none;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(251,191,36,0.35);
            letter-spacing: 0.02em;
            margin-bottom: 1.5rem;
        }
        .pl-cta-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 40px rgba(251,191,36,0.45);
        }
        .pl-cta-btn:active { transform: translateY(-1px); }

        .pl-share {
            border-top: 1px solid #f1f5f9;
            padding-top: 2rem;
        }
        .pl-share-title {
            font-size: 0.85rem; font-weight: 600; color: var(--muted);
            text-transform: uppercase; letter-spacing: 0.08em;
            margin-bottom: 1rem;
        }
        .pl-share-row { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .pl-share-btn {
            width: 46px; height: 46px;
            border-radius: 50%; border: none; cursor: pointer;
            font-size: 1.1rem;
            display: inline-flex; align-items: center; justify-content: center;
            color: white; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .pl-share-btn:hover { transform: scale(1.12); box-shadow: 0 6px 18px rgba(0,0,0,0.15); }
        .pl-share-btn.wa  { background: #25D366; }
        .pl-share-btn.fb  { background: #1877F2; }
        .pl-share-btn.tw  { background: #000; }
        .pl-share-btn.cp  { background: var(--muted); }

        /* â”€â”€ Org Fallback Card (when no page.content) â”€ */
        #orgFallbackWrap {
            display: none;
            max-width: 720px;
            margin: 2.5rem auto;
            padding: 0 1rem 4rem;
        }
        .of-card {
            background: white; border-radius: var(--radius);
            overflow: hidden; box-shadow: var(--shadow);
        }
        .of-image {
            width: 100%; height: 380px; object-fit: cover; display: block;
        }
        .of-body { padding: 2.5rem; }
        .of-title { font-size: 2rem; font-weight: 900; color: var(--dark); margin-bottom: 1rem; }
        .of-desc { font-size: 1.05rem; color: var(--muted); line-height: 1.7; margin-bottom: 2rem; }
        .of-cta {
            display: inline-flex; align-items: center; gap: 0.6rem;
            background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
            color: white; padding: 1rem 2.5rem;
            border-radius: 3rem; text-decoration: none;
            font-size: 1rem; font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(102,126,234,0.35);
        }
        .of-cta:hover { transform: translateY(-3px); box-shadow: 0 16px 40px rgba(102,126,234,0.45); }

        .of-socials {
            margin-top: 2rem; padding-top: 1.5rem;
            border-top: 1px solid #f1f5f9;
        }
        .of-socials-title { font-size: 0.85rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; }
        .of-socials-row { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .of-social-link {
            width: 46px; height: 46px;
            border-radius: 50%; display: inline-flex;
            align-items: center; justify-content: center;
            font-size: 1.1rem; color: white;
            text-decoration: none;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .of-social-link:hover { transform: scale(1.12); box-shadow: 0 6px 18px rgba(0,0,0,0.15); }

        /* â”€â”€ Error Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #errorScreen {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            align-items: center; justify-content: center;
            flex-direction: column;
            text-align: center; color: white; padding: 3rem;
        }
        #errorScreen.show { display: flex; }
        .err-icon { font-size: 5rem; margin-bottom: 1.5rem; }
        .err-title { font-size: 2rem; font-weight: 800; margin-bottom: 0.75rem; }
        .err-msg { font-size: 1rem; opacity: 0.85; margin-bottom: 2.5rem; max-width: 400px; }
        .err-btn {
            display: inline-flex; align-items: center; gap: 0.6rem;
            background: white; color: var(--primary);
            padding: 1rem 2rem; border-radius: 3rem;
            font-weight: 700; text-decoration: none;
            transition: transform 0.2s;
        }
        .err-btn:hover { transform: scale(1.05); }

        /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .lp-footer {
            background: var(--dark2); color: rgba(255,255,255,0.5);
            text-align: center; padding: 1.5rem 2rem;
            font-size: 0.85rem;
        }
        .lp-footer a { color: var(--primary); text-decoration: none; }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 640px) {
            .pl-title, .of-title { font-size: 1.6rem; }
            .pl-price { font-size: 2.5rem; }
            .pl-hero-image, .pl-hero-image-placeholder, .of-image { height: 260px; }
            .pl-hero-body, .of-body { padding: 1.5rem; }
        }
        #lpNav, #lpFooter { display: none; }

        /* â”€â”€ QR Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .qr-overlay {
            display: none; position: fixed; inset: 0; z-index: 9000;
            background: rgba(0,0,0,0.65);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            align-items: center; justify-content: center;
            padding: 1rem;
        }
        .qr-overlay.show { display: flex; }

        .qr-modal {
            background: white; border-radius: 1.5rem;
            padding: 2rem; max-width: 420px; width: 100%;
            text-align: center;
            box-shadow: 0 40px 80px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(.34,1.56,.64,1);
        }
        @keyframes popIn {
            from { transform: scale(0.85); opacity: 0; }
            to   { transform: scale(1);    opacity: 1; }
        }

        .qr-modal-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .qr-modal-title {
            font-size: 1.3rem; font-weight: 800;
            color: var(--dark); margin-bottom: 0.4rem;
        }
        .qr-modal-sub { font-size: 0.9rem; color: var(--muted); margin-bottom: 1.5rem; }

        /* confirm step */
        .qr-confirm-warning {
            background: #fef9ec; border: 1.5px solid #fbbf24;
            border-radius: 0.75rem; padding: 0.8rem 1rem;
            font-size: 0.85rem; color: #92400e;
            margin-bottom: 1.5rem; text-align: left;
        }
        .qr-confirm-warning i { margin-right: 6px; }
        .qr-btn-row { display: flex; gap: 0.75rem; }
        .qr-btn {
            flex: 1; padding: 0.9rem; border-radius: 0.75rem;
            font-weight: 700; font-size: 1rem; border: none; cursor: pointer;
            transition: all 0.2s;
        }
        .qr-btn.cancel { background: #f1f5f9; color: var(--muted); }
        .qr-btn.cancel:hover { background: #e2e8f0; }
        .qr-btn.confirm {
            background: linear-gradient(135deg, var(--primary), #764ba2);
            color: white;
            box-shadow: 0 8px 20px rgba(102,126,234,0.35);
        }
        .qr-btn.confirm:hover { transform: translateY(-2px); }

        /* qr display step */
        .qr-display-step { display: none; }
        #qrCanvas {
            border-radius: 1rem; margin: 1rem auto;
            border: 4px solid #f1f5f9;
            display: block;
        }
        .qr-countdown {
            font-size: 1.5rem; font-weight: 800;
            color: var(--primary); margin: 0.5rem 0 1rem;
        }
        .qr-countdown.urgent { color: #ef4444; }
        .qr-progress {
            height: 6px; background: #f1f5f9; border-radius: 3px;
            overflow: hidden; margin-bottom: 1rem;
        }
        .qr-progress-bar {
            height: 100%; border-radius: 3px;
            background: linear-gradient(90deg, var(--primary), #764ba2);
            transition: width 1s linear;
        }
        .qr-status-msg {
            font-size: 0.9rem; color: var(--muted);
            margin-bottom: 1.5rem;
        }
        .qr-expired-msg {
            display: none; color: #ef4444;
            font-weight: 700; font-size: 1rem; margin: 1rem 0;
        }

        /* riscatta button */
        .riscatta-btn {
            display: flex; align-items: center; justify-content: center; gap: 0.6rem;
            width: 100%; padding: 1.1rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; border: none; border-radius: 1rem;
            font-size: 1.05rem; font-weight: 800; cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 24px rgba(16,185,129,0.35);
            text-decoration: none;
        }
        .riscatta-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(16,185,129,0.45); }

    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <p>Caricamento in corso...</p>
    </div>

    <!-- Error -->
    <div id="errorScreen">
        <div class="err-icon">ğŸ˜¢</div>
        <div class="err-title" id="errTitle">Pagina non trovata</div>
        <div class="err-msg" id="errMsg">Questa promozione non esiste o non Ã¨ piÃ¹ disponibile.</div>
        <a href="/public/promotions.html" class="err-btn">
            <i class="fas fa-arrow-left"></i> Torna alle Promozioni
        </a>
    </div>

    <!-- Navbar (shown for all landing types) -->
    <nav class="lp-nav" id="lpNav">
        <a href="/public/index.html" class="lp-nav-logo">
            <i class="fas fa-tag"></i> <span>CDM86</span>
        </a>
        <a href="/public/promotions.html" class="lp-nav-back">
            <i class="fas fa-arrow-left"></i> Tutte le promozioni
        </a>
    </nav>

    <!-- Org Landing (sections from landing builder) -->
    <div id="orgLandingWrap">
        <div id="orgLandingSections"></div>
        <!-- Share bar injected here -->
    </div>

    <!-- Org Fallback (no page.content, render from card_data) -->
    <div id="orgFallbackWrap">
        <div class="of-card" id="orgFallbackCard"></div>
    </div>

    <!-- Standard Promo Landing (from promotions table) -->
    <div id="promoLandingWrap">
        <div class="pl-hero">
            <div id="plHeroImageWrap"></div>
            <div class="pl-hero-body">
                <div class="pl-badge" id="plBadge"></div>
                <h1 class="pl-title" id="plTitle"></h1>
                <p class="pl-desc" id="plDesc"></p>
                <div class="pl-pricing" id="plPricing"></div>
                <div id="plSavings"></div>
                <button class="pl-cta-btn" id="plCtaBtn"></button>
                <!-- Riscatta Promo button (shown only for promos with landing_slug) -->
                <button class="riscatta-btn" id="plRiscattaBtn" style="display:none;margin-bottom:1rem;" onclick="openRedeemModal()">
                    <i class="fas fa-qrcode"></i> Riscatta Promo
                </button>
                <div class="pl-share">
                    <div class="pl-share-title">Condividi questa offerta</div>
                    <div class="pl-share-row">
                        <button class="pl-share-btn wa" onclick="shareWA()" title="WhatsApp"><i class="fab fa-whatsapp"></i></button>
                        <button class="pl-share-btn fb" onclick="shareFB()" title="Facebook"><i class="fab fa-facebook-f"></i></button>
                        <button class="pl-share-btn tw" onclick="shareTW()" title="Twitter / X"><i class="fab fa-x-twitter"></i></button>
                        <button class="pl-share-btn cp" onclick="copyLink()" title="Copia link"><i class="fas fa-link"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Redeem Modal -->
    <div class="qr-overlay" id="qrOverlay">
        <div class="qr-modal">
            <!-- Step 1: Confirm -->
            <div id="qrConfirmStep">
                <div class="qr-modal-icon">ğŸŸï¸</div>
                <div class="qr-modal-title">Riscatta la Promo</div>
                <div class="qr-modal-sub" id="qrPromoName"></div>
                <div class="qr-confirm-warning">
                    <i class="fas fa-clock"></i>
                    Il codice QR ha validitÃ  di <strong>5 minuti</strong> e sarÃ  scansionato dal gestore.<br>
                    Dopo la validazione non potrÃ  essere riutilizzato.
                </div>
                <div id="qrUsesInfo" style="font-size:0.85rem;color:#64748b;margin-bottom:1.2rem;"></div>
                <div class="qr-btn-row">
                    <button class="qr-btn cancel" onclick="closeRedeemModal()">Annulla</button>
                    <button class="qr-btn confirm" onclick="generateQR()">
                        <i class="fas fa-qrcode"></i> Genera QR
                    </button>
                </div>
            </div>

            <!-- Step 2: QR Display -->
            <div id="qrDisplayStep" style="display:none;">
                <div class="qr-modal-icon">ğŸ“±</div>
                <div class="qr-modal-title">Mostra al Gestore</div>
                <div class="qr-modal-sub">Scansiona entro il tempo limite</div>
                <canvas id="qrCanvas" width="220" height="220"></canvas>
                <div class="qr-progress"><div class="qr-progress-bar" id="qrProgressBar" style="width:100%"></div></div>
                <div class="qr-countdown" id="qrCountdown">5:00</div>
                <div class="qr-status-msg" id="qrStatusMsg">In attesa di validazione dal gestore...</div>
                <div class="qr-expired-msg" id="qrExpiredMsg">
                    â° Codice scaduto!<br><small>Genera un nuovo QR per riprovare.</small>
                </div>
                <div class="qr-btn-row">
                    <button class="qr-btn cancel" onclick="closeRedeemModal()">Chiudi</button>
                    <button class="qr-btn confirm" id="qrNewBtn" style="display:none;" onclick="generateQR()">
                        <i class="fas fa-redo"></i> Nuovo QR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="lp-footer" id="lpFooter">
        &copy; 2024 <a href="/public/index.html">CDM86</a> â€” Promozioni esclusive per te
    </footer>

    <script>
        let supabaseClient;
        const urlParams = new URLSearchParams(window.location.search);
        const slug = (window.location.pathname.split('/promo/')[1] || '').replace(/\/$/, '') || urlParams.get('slug');

        if (typeof CDM86_CONFIG !== 'undefined' && CDM86_CONFIG.supabase) {
            supabaseClient = supabase.createClient(CDM86_CONFIG.supabase.url, CDM86_CONFIG.supabase.anonKey);
        }

        // â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function hideLoading() {
            const ls = document.getElementById('loadingScreen');
            ls.style.opacity = '0';
            setTimeout(() => ls.style.display = 'none', 400);
        }

        function showNav() {
            document.getElementById('lpNav').style.display = 'flex';
            document.getElementById('lpFooter').style.display = 'block';
        }

        function showError(title, msg) {
            hideLoading();
            document.getElementById('errTitle').textContent = title;
            document.getElementById('errMsg').textContent = msg;
            document.getElementById('errorScreen').classList.add('show');
        }

        // â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadPromo() {
            if (!slug) { showError('Promo non trovata', 'URL non valido.'); return; }
            if (!supabaseClient) { showError('Errore configurazione', 'Database non raggiungibile.'); return; }

            try {
                // 1ï¸âƒ£ organization_pages (landing builder)
                const { data: orgPage } = await supabaseClient
                    .from('organization_pages')
                    .select('*')
                    .or(`slug.eq.${slug},landing_slug.eq.${slug}`)
                    .eq('card_published', true)
                    .maybeSingle();

                if (orgPage) { renderOrgLanding(orgPage); return; }

                // 2ï¸âƒ£ promotions table (promo-creator)
                const { data: promo, error } = await supabaseClient
                    .from('promotions')
                    .select('*')
                    .eq('landing_slug', slug)
                    .eq('is_active', true)
                    .maybeSingle();

                if (promo) { renderPromo(promo); return; }

                showError('Promozione non trovata', 'Questa offerta non Ã¨ piÃ¹ disponibile o il link non Ã¨ corretto.');

            } catch (err) {
                console.error('loadPromo error:', err);
                showError('Errore di caricamento', err.message || 'Riprova piÃ¹ tardi.');
            }
        }

        // â”€â”€ Render: Org Landing (landing builder) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function renderOrgLanding(page) {
            showNav();
            const pageData = page.page_data || {};
            const cardData = page.card_data || {};
            const title = cardData.title || page.page_title || 'Offerta';

            // Update <title> and OG tags
            document.getElementById('pageTitle').textContent = title + ' â€” CDM86';
            document.getElementById('ogTitle').setAttribute('content', title);
            document.getElementById('ogDescription').setAttribute('content', cardData.description || page.page_description || '');
            if (cardData.image) document.getElementById('ogImage').setAttribute('content', cardData.image);

            // Try to load the linked promo for QR redemption
            if (page.promo_id) {
                currentPromoId = page.promo_id;
                currentPromoTitle = title;
            } else if (page.partner_email) {
                try {
                    const { data: linkedPromo } = await supabaseClient
                        .from('promotions')
                        .select('id, title')
                        .eq('partner_email', page.partner_email)
                        .eq('is_active', true)
                        .maybeSingle();
                    if (linkedPromo) {
                        currentPromoId = linkedPromo.id;
                        currentPromoTitle = linkedPromo.title || title;
                    }
                } catch (e) { console.warn('Could not load linked promo:', e); }
            }

            if (page.content) {
                // â”€â”€ Full HTML snapshot from builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const wrap = document.getElementById('orgLandingWrap');
                const sectionsDiv = document.getElementById('orgLandingSections');
                sectionsDiv.innerHTML = page.content;

                // Append social bar if not already in content
                const socialLinks = page.social_links || cardData.socialLinks || {};
                const hasSocial = sectionsDiv.querySelector('.landing-social-bar');
                if (!hasSocial) {
                    const socialHtml = buildSocialBarHtml(socialLinks);
                    if (socialHtml) sectionsDiv.insertAdjacentHTML('beforeend', socialHtml);
                }

                // Show riscatta button if we have a promo linked
                if (currentPromoId) {
                    document.getElementById('plRiscattaBtn').style.display = 'flex';
                }

                wrap.style.display = 'block';
                hideLoading();

            } else {
                // â”€â”€ Fallback: render from card_data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                renderOrgFallback(page, cardData, pageData);
            }
        }

        function renderOrgFallback(page, cardData, pageData) {
            const socialLinks = page.social_links || cardData.socialLinks || {};
            const ctaLink = cardData.ctaLinkHero || pageData.ctaLinkHero || socialLinks.whatsapp || socialLinks.website || null;
            const title = cardData.title || page.page_title || 'Offerta Speciale';
            const desc = cardData.description || page.page_description || '';

            const socialHtml = buildSocialIconsHtml(socialLinks);

            document.getElementById('orgFallbackCard').innerHTML = `
                ${cardData.image ? `<img src="${cardData.image}" alt="${title}" class="of-image">` : `
                    <div style="width:100%;height:240px;background:linear-gradient(135deg,#c7d2fe,#818cf8);display:flex;align-items:center;justify-content:center;font-size:4rem;">ğŸ·ï¸</div>
                `}
                <div class="of-body">
                    <div class="pl-badge" style="display:inline-flex;margin-bottom:1.2rem;">${cardData.badge || 'â­ OFFERTA'}</div>
                    <h1 class="of-title">${title}</h1>
                    <p class="of-desc">${desc}</p>
                    ${ctaLink ? `
                        <a href="${ctaLink}" class="of-cta" target="_blank" rel="noopener">
                            <i class="fas fa-arrow-right"></i> ${cardData.ctaText || 'SCOPRI DI PIÃ™'}
                        </a>
                    ` : ''}
                    ${socialHtml ? `
                        <div class="of-socials">
                            <div class="of-socials-title">Seguici sui social</div>
                            <div class="of-socials-row">${socialHtml}</div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('orgFallbackWrap').style.display = 'block';

            // Show riscatta button if we have a promo linked
            if (currentPromoId) {
                document.getElementById('plRiscattaBtn').style.display = 'flex';
            }

            hideLoading();
        }

        // â”€â”€ Render: Standard Promo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderPromo(promo) {
            document.getElementById('pageTitle').textContent = promo.title + ' â€” CDM86';
            document.getElementById('ogTitle').setAttribute('content', promo.title);
            document.getElementById('ogDescription').setAttribute('content', promo.description || '');
            if (promo.image_url) document.getElementById('ogImage').setAttribute('content', promo.image_url);

            // Store for QR modal
            currentPromoId = promo.id;
            currentPromoTitle = promo.title;

            const savings = promo.original_price && promo.price
                ? Math.round(((promo.original_price - promo.price) / promo.original_price) * 100) : 0;

            // Hero image
            const imgWrap = document.getElementById('plHeroImageWrap');
            imgWrap.innerHTML = promo.image_url
                ? `<img src="${promo.image_url}" alt="${promo.title}" class="pl-hero-image" onerror="this.parentElement.innerHTML='<div class=\\'pl-hero-image-placeholder\\'>ğŸ·ï¸</div>'">`
                : `<div class="pl-hero-image-placeholder">ğŸ·ï¸</div>`;

            document.getElementById('plBadge').textContent = getCategoryLabel(promo.category);
            document.getElementById('plTitle').textContent = promo.title;
            document.getElementById('plDesc').textContent = promo.description || '';

            // Pricing
            const pricingEl = document.getElementById('plPricing');
            if (promo.price != null) {
                pricingEl.innerHTML = `
                    <div class="pl-price">â‚¬${Number(promo.price).toFixed(2)}</div>
                    ${promo.original_price ? `<div class="pl-original">â‚¬${Number(promo.original_price).toFixed(2)}</div>` : ''}
                `;
            } else {
                pricingEl.style.display = 'none';
            }

            // Savings badge
            const savingsEl = document.getElementById('plSavings');
            if (savings > 0) {
                savingsEl.innerHTML = `<div class="pl-savings">ğŸ‰ Risparmi il ${savings}%</div>`;
            }

            // CTA â€” hidden for org promos that go to landing (riscatta btn replaces it)
            const ctaBtn = document.getElementById('plCtaBtn');
            ctaBtn.style.display = 'none';

            // Show riscatta button
            const riscattaBtn = document.getElementById('plRiscattaBtn');
            riscattaBtn.style.display = 'flex';

            showNav();
            document.getElementById('promoLandingWrap').style.display = 'block';
            hideLoading();
        }

        // â”€â”€ Social helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const SOCIAL_DEFS = [
            { key: 'facebook',  icon: 'fab fa-facebook-f',  color: '#1877f2', label: 'Facebook' },
            { key: 'instagram', icon: 'fab fa-instagram',   color: '#e1306c', label: 'Instagram' },
            { key: 'twitter',   icon: 'fab fa-x-twitter',   color: '#000',    label: 'X / Twitter' },
            { key: 'linkedin',  icon: 'fab fa-linkedin-in', color: '#0a66c2', label: 'LinkedIn' },
            { key: 'tiktok',    icon: 'fab fa-tiktok',      color: '#010101', label: 'TikTok' },
            { key: 'whatsapp',  icon: 'fab fa-whatsapp',    color: '#25d366', label: 'WhatsApp' },
            { key: 'website',   icon: 'fas fa-globe',       color: '#667eea', label: 'Sito Web' }
        ];

        function buildSocialIconsHtml(links) {
            if (!links) return '';
            return SOCIAL_DEFS
                .filter(d => links[d.key])
                .map(d => `
                    <a href="${links[d.key]}" target="_blank" rel="noopener" title="${d.label}" class="of-social-link" style="background:${d.color};">
                        <i class="${d.icon}"></i>
                    </a>
                `).join('');
        }

        function buildSocialBarHtml(links) {
            if (!links) return '';
            const active = SOCIAL_DEFS.filter(d => links[d.key]);
            if (!active.length) return '';
            return `
                <div class="landing-social-bar" style="background:#1e293b;padding:3rem 2rem;text-align:center;">
                    <h3 style="color:white;margin-bottom:1.5rem;font-size:1.2rem;font-family:Inter,sans-serif;">Seguici sui Social</h3>
                    <div class="landing-social-icons" style="display:flex;justify-content:center;gap:1rem;flex-wrap:wrap;">
                        ${active.map(d => `
                            <a href="${links[d.key]}" class="landing-social-link" style="background:${d.color};width:52px;height:52px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:1.3rem;color:white;text-decoration:none;" target="_blank" rel="noopener" title="${d.label}">
                                <i class="${d.icon}"></i>
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // â”€â”€ Category labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getCategoryLabel(cat) {
            const map = {
                food: 'ğŸ• Cibo & Drink', beauty: 'ğŸ’‡ Bellezza',
                wellness: 'ğŸ§˜ Benessere', shopping: 'ğŸ›ï¸ Shopping',
                entertainment: 'ğŸ­ Intrattenimento', travel: 'âœˆï¸ Viaggi'
            };
            return map[cat] || 'ğŸ Offerta Speciale';
        }

        // â”€â”€ Redeem / QR system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let currentPromoId = null;
        let currentPromoTitle = '';
        let qrCountdownInterval = null;
        let qrPollInterval = null;

        // Called when "Riscatta Promo" button is clicked (from landing or card)
        function openRedeemModal(promoId, promoTitle) {
            if (promoId) currentPromoId = promoId;
            if (promoTitle) currentPromoTitle = promoTitle;

            // Reset to confirm step
            document.getElementById('qrConfirmStep').style.display = 'block';
            document.getElementById('qrDisplayStep').style.display = 'none';
            document.getElementById('qrPromoName').textContent = currentPromoTitle || document.title.replace(' â€” CDM86','');
            document.getElementById('qrOverlay').classList.add('show');
        }

        function closeRedeemModal() {
            document.getElementById('qrOverlay').classList.remove('show');
            clearInterval(qrCountdownInterval);
            clearInterval(qrPollInterval);
        }

        async function generateQR() {
            if (!supabaseClient) {
                alert('Errore: sessione non disponibile. Ricarica la pagina.');
                return;
            }

            // Check auth
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                alert('âš ï¸ Devi essere loggato per riscattare questa promo.');
                closeRedeemModal();
                window.location.href = '/public/index.html';
                return;
            }

            const btn = document.querySelector('#qrConfirmStep .qr-btn.confirm');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generazione...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/redeem-promo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        promo_id: currentPromoId,
                        user_id: session.user.id
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    alert('âŒ ' + (data.error || 'Errore nella generazione del codice.'));
                    btn.innerHTML = '<i class="fas fa-qrcode"></i> Genera QR';
                    btn.disabled = false;
                    return;
                }

                // Show QR step
                document.getElementById('qrConfirmStep').style.display = 'none';
                document.getElementById('qrDisplayStep').style.display = 'block';
                document.getElementById('qrExpiredMsg').style.display = 'none';
                document.getElementById('qrNewBtn').style.display = 'none';
                document.getElementById('qrStatusMsg').style.display = 'block';
                document.getElementById('qrStatusMsg').textContent = 'In attesa di validazione dal gestore...';

                // Draw QR on canvas
                const canvas = document.getElementById('qrCanvas');
                await QRCode.toCanvas(canvas, data.qr_data, {
                    width: 220, margin: 2,
                    color: { dark: '#1e293b', light: '#ffffff' }
                });

                // Countdown 5 min
                const expiresAt = new Date(data.expires_at).getTime();
                const totalMs = 5 * 60 * 1000;
                const progressBar = document.getElementById('qrProgressBar');
                const countdownEl = document.getElementById('qrCountdown');

                clearInterval(qrCountdownInterval);
                qrCountdownInterval = setInterval(() => {
                    const remaining = expiresAt - Date.now();
                    if (remaining <= 0) {
                        clearInterval(qrCountdownInterval);
                        clearInterval(qrPollInterval);
                        countdownEl.textContent = '0:00';
                        countdownEl.classList.add('urgent');
                        progressBar.style.width = '0%';
                        progressBar.style.background = '#ef4444';
                        document.getElementById('qrStatusMsg').style.display = 'none';
                        document.getElementById('qrExpiredMsg').style.display = 'block';
                        document.getElementById('qrNewBtn').style.display = 'block';
                        return;
                    }
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    countdownEl.textContent = `${mins}:${secs.toString().padStart(2,'0')}`;
                    const pct = (remaining / totalMs) * 100;
                    progressBar.style.width = pct + '%';
                    if (remaining < 60000) {
                        countdownEl.classList.add('urgent');
                        progressBar.style.background = '#ef4444';
                    }
                }, 1000);

                // Poll every 5s to check if validated
                clearInterval(qrPollInterval);
                qrPollInterval = setInterval(async () => {
                    try {
                        const { data: tokenRow } = await supabaseClient
                            .from('redemption_tokens')
                            .select('status')
                            .eq('token', data.token)
                            .maybeSingle();

                        if (tokenRow?.status === 'used') {
                            clearInterval(qrCountdownInterval);
                            clearInterval(qrPollInterval);
                            countdownEl.textContent = 'âœ…';
                            countdownEl.classList.remove('urgent');
                            progressBar.style.width = '100%';
                            progressBar.style.background = '#10b981';
                            document.getElementById('qrStatusMsg').textContent = 'âœ… Promo validata con successo!';
                            document.getElementById('qrStatusMsg').style.color = '#10b981';
                        }
                    } catch (_) { /* silently ignore polling errors */ }
                }, 5000);

            } catch (err) {
                console.error('generateQR error:', err);
                alert('âŒ Errore di rete. Riprova.');
                btn.innerHTML = '<i class="fas fa-qrcode"></i> Genera QR';
                btn.disabled = false;
            }
        }

        // â”€â”€ Share â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function shareWA() {
            const t = encodeURIComponent(`ğŸ Guarda questa offerta su CDM86!\n${window.location.href}`);
            window.open(`https://wa.me/?text=${t}`, '_blank');
        }
        function shareFB() {
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank');
        }
        function shareTW() {
            const t = encodeURIComponent(document.title);
            window.open(`https://twitter.com/intent/tweet?text=${t}&url=${encodeURIComponent(window.location.href)}`, '_blank');
        }
        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const btn = document.querySelector('.pl-share-btn.cp');
                if (btn) { btn.innerHTML = '<i class="fas fa-check"></i>'; setTimeout(() => btn.innerHTML = '<i class="fas fa-link"></i>', 2000); }
            });
        }

        window.addEventListener('DOMContentLoaded', loadPromo);
    </script>
</body>
</html>
