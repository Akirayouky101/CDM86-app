<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Promozione - CDM86</title>
    <meta name="description" id="pageDescription" content="Scopri questa incredibile offerta su CDM86!">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" id="ogTitle" content="Promozione CDM86">
    <meta property="og:description" id="ogDescription" content="Scopri questa incredibile offerta!">
    <meta property="og:image" id="ogImage" content="">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" id="twitterTitle" content="Promozione CDM86">
    <meta property="twitter:description" id="twitterDescription" content="Scopri questa incredibile offerta!">
    <meta property="twitter:image" id="twitterImage" content="">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/assets/js/config.js"></script>
    
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #667eea;
            --primary-dark: #5a6fd6;
            --accent: #fbbf24;
            --accent-dark: #f59e0b;
            --dark: #0f172a;
            --dark2: #1e293b;
            --muted: #64748b;
            --light: #f8fafc;
            --white: #ffffff;
            --radius: 1.25rem;
            --shadow: 0 25px 60px rgba(0,0,0,0.15);
            --shadow-sm: 0 4px 20px rgba(0,0,0,0.08);
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--light);
            color: var(--dark2);
            min-height: 100vh;
        }

        /* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #loadingScreen {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999; color: white;
            transition: opacity 0.4s;
        }
        #loadingScreen .spinner {
            width: 56px; height: 56px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1.5rem;
        }
        #loadingScreen p { font-size: 1.1rem; font-weight: 600; opacity: 0.9; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ Navbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .lp-nav {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.95);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.06);
            padding: 1rem 2rem;
            display: flex; align-items: center; justify-content: space-between;
        }
        .lp-nav-logo {
            display: flex; align-items: center; gap: 0.6rem;
            text-decoration: none;
            font-weight: 800; font-size: 1.2rem; color: var(--dark2);
        }
        .lp-nav-logo span {
            background: linear-gradient(135deg, var(--primary), #764ba2);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .lp-nav-back {
            display: flex; align-items: center; gap: 0.5rem;
            text-decoration: none; color: var(--muted);
            font-size: 0.9rem; font-weight: 500;
            transition: color 0.2s;
        }
        .lp-nav-back:hover { color: var(--primary); }

        /* â”€â”€ Org Landing (from landing builder) â”€â”€â”€ */
        #orgLandingWrap {
            display: none;
            font-family: 'Inter', sans-serif;
        }
        #orgLandingWrap * { font-family: inherit; }

        /* Enhance existing section styles injected by builder */
        #orgLandingWrap .section-hero {
            position: relative; overflow: hidden;
        }
        #orgLandingWrap .section-hero::before {
            content: '';
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.15);
            z-index: 1;
        }
        #orgLandingWrap .section-hero > * { position: relative; z-index: 2; }

        #orgLandingWrap .landing-social-bar {
            background: var(--dark2) !important;
            padding: 3rem 2rem !important;
        }
        #orgLandingWrap .landing-social-icons {
            display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;
        }
        #orgLandingWrap .landing-social-link {
            width: 52px; height: 52px;
            border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 1.3rem; color: white;
            text-decoration: none;
            transition: transform 0.25s, box-shadow 0.25s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        #orgLandingWrap .landing-social-link:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        /* â”€â”€ Promo Landing (standard promo card) â”€â”€ */
        #promoLandingWrap {
            display: none;
            max-width: 720px;
            margin: 2.5rem auto;
            padding: 0 1rem 4rem;
        }

        .pl-hero {
            border-radius: var(--radius);
            overflow: hidden;
            background: white;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        .pl-hero-image {
            width: 100%; height: 420px;
            object-fit: cover;
            display: block;
        }
        .pl-hero-image-placeholder {
            width: 100%; height: 420px;
            background: linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 50%, #818cf8 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 5rem;
        }
        .pl-hero-body { padding: 2.5rem; }
        .pl-badge {
            display: inline-flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: #1e3a8a;
            padding: 0.45rem 1.1rem;
            border-radius: 2rem;
            font-size: 0.8rem; font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            margin-bottom: 1.2rem;
        }
        .pl-title {
            font-size: 2.2rem; font-weight: 900;
            color: var(--dark); line-height: 1.2;
            margin-bottom: 1rem;
        }
        .pl-desc {
            font-size: 1.1rem; color: var(--muted);
            line-height: 1.7; margin-bottom: 1.8rem;
        }
        .pl-pricing {
            display: flex; align-items: baseline; gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .pl-price {
            font-size: 3.2rem; font-weight: 900;
            color: var(--primary); line-height: 1;
        }
        .pl-original {
            font-size: 1.4rem; color: #cbd5e1;
            text-decoration: line-through;
        }
        .pl-savings {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 2rem;
            font-size: 0.85rem; font-weight: 700;
            margin-bottom: 1.8rem;
        }
        .pl-cta-btn {
            display: block; width: 100%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: #1e3a8a;
            padding: 1.2rem 2rem;
            border-radius: 1rem;
            font-size: 1.15rem; font-weight: 800;
            border: none; cursor: pointer;
            text-align: center; text-decoration: none;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(251,191,36,0.35);
            letter-spacing: 0.02em;
            margin-bottom: 1.5rem;
        }
        .pl-cta-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 40px rgba(251,191,36,0.45);
        }
        .pl-cta-btn:active { transform: translateY(-1px); }

        .pl-share {
            border-top: 1px solid #f1f5f9;
            padding-top: 2rem;
        }
        .pl-share-title {
            font-size: 0.85rem; font-weight: 600; color: var(--muted);
            text-transform: uppercase; letter-spacing: 0.08em;
            margin-bottom: 1rem;
        }
        .pl-share-row { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .pl-share-btn {
            width: 46px; height: 46px;
            border-radius: 50%; border: none; cursor: pointer;
            font-size: 1.1rem;
            display: inline-flex; align-items: center; justify-content: center;
            color: white; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .pl-share-btn:hover { transform: scale(1.12); box-shadow: 0 6px 18px rgba(0,0,0,0.15); }
        .pl-share-btn.wa  { background: #25D366; }
        .pl-share-btn.fb  { background: #1877F2; }
        .pl-share-btn.tw  { background: #000; }
        .pl-share-btn.cp  { background: var(--muted); }

        /* â”€â”€ Org Fallback Card (when no page.content) â”€ */
        #orgFallbackWrap {
            display: none;
            max-width: 720px;
            margin: 2.5rem auto;
            padding: 0 1rem 4rem;
        }
        .of-card {
            background: white; border-radius: var(--radius);
            overflow: hidden; box-shadow: var(--shadow);
        }
        .of-image {
            width: 100%; height: 380px; object-fit: cover; display: block;
        }
        .of-body { padding: 2.5rem; }
        .of-title { font-size: 2rem; font-weight: 900; color: var(--dark); margin-bottom: 1rem; }
        .of-desc { font-size: 1.05rem; color: var(--muted); line-height: 1.7; margin-bottom: 2rem; }
        .of-cta {
            display: inline-flex; align-items: center; gap: 0.6rem;
            background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
            color: white; padding: 1rem 2.5rem;
            border-radius: 3rem; text-decoration: none;
            font-size: 1rem; font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(102,126,234,0.35);
        }
        .of-cta:hover { transform: translateY(-3px); box-shadow: 0 16px 40px rgba(102,126,234,0.45); }

        .of-socials {
            margin-top: 2rem; padding-top: 1.5rem;
            border-top: 1px solid #f1f5f9;
        }
        .of-socials-title { font-size: 0.85rem; font-weight: 600; color: var(--muted); margin-bottom: 1rem; }
        .of-socials-row { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .of-social-link {
            width: 46px; height: 46px;
            border-radius: 50%; display: inline-flex;
            align-items: center; justify-content: center;
            font-size: 1.1rem; color: white;
            text-decoration: none;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .of-social-link:hover { transform: scale(1.12); box-shadow: 0 6px 18px rgba(0,0,0,0.15); }

        /* â”€â”€ Error Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #errorScreen {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            align-items: center; justify-content: center;
            flex-direction: column;
            text-align: center; color: white; padding: 3rem;
        }
        #errorScreen.show { display: flex; }
        .err-icon { font-size: 5rem; margin-bottom: 1.5rem; }
        .err-title { font-size: 2rem; font-weight: 800; margin-bottom: 0.75rem; }
        .err-msg { font-size: 1rem; opacity: 0.85; margin-bottom: 2.5rem; max-width: 400px; }
        .err-btn {
            display: inline-flex; align-items: center; gap: 0.6rem;
            background: white; color: var(--primary);
            padding: 1rem 2rem; border-radius: 3rem;
            font-weight: 700; text-decoration: none;
            transition: transform 0.2s;
        }
        .err-btn:hover { transform: scale(1.05); }

        /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .lp-footer {
            background: var(--dark2); color: rgba(255,255,255,0.5);
            text-align: center; padding: 1.5rem 2rem;
            font-size: 0.85rem;
        }
        .lp-footer a { color: var(--primary); text-decoration: none; }

        /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 640px) {
            .pl-title, .of-title { font-size: 1.6rem; }
            .pl-price { font-size: 2.5rem; }
            .pl-hero-image, .pl-hero-image-placeholder, .of-image { height: 260px; }
            .pl-hero-body, .of-body { padding: 1.5rem; }
        }
        #lpNav, #lpFooter { display: none; }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <p>Caricamento in corso...</p>
    </div>

    <!-- Error -->
    <div id="errorScreen">
        <div class="err-icon">ğŸ˜¢</div>
        <div class="err-title" id="errTitle">Pagina non trovata</div>
        <div class="err-msg" id="errMsg">Questa promozione non esiste o non Ã¨ piÃ¹ disponibile.</div>
        <a href="/public/promotions.html" class="err-btn">
            <i class="fas fa-arrow-left"></i> Torna alle Promozioni
        </a>
    </div>

    <!-- Navbar (shown for all landing types) -->
    <nav class="lp-nav" id="lpNav">
        <a href="/public/index.html" class="lp-nav-logo">
            <i class="fas fa-tag"></i> <span>CDM86</span>
        </a>
        <a href="/public/promotions.html" class="lp-nav-back">
            <i class="fas fa-arrow-left"></i> Tutte le promozioni
        </a>
    </nav>

    <!-- Org Landing (sections from landing builder) -->
    <div id="orgLandingWrap">
        <div id="orgLandingSections"></div>
        <!-- Share bar injected here -->
    </div>

    <!-- Org Fallback (no page.content, render from card_data) -->
    <div id="orgFallbackWrap">
        <div class="of-card" id="orgFallbackCard"></div>
    </div>

    <!-- Standard Promo Landing (from promotions table) -->
    <div id="promoLandingWrap">
        <div class="pl-hero">
            <div id="plHeroImageWrap"></div>
            <div class="pl-hero-body">
                <div class="pl-badge" id="plBadge"></div>
                <h1 class="pl-title" id="plTitle"></h1>
                <p class="pl-desc" id="plDesc"></p>
                <div class="pl-pricing" id="plPricing"></div>
                <div id="plSavings"></div>
                <button class="pl-cta-btn" id="plCtaBtn"></button>
                <div class="pl-share">
                    <div class="pl-share-title">Condividi questa offerta</div>
                    <div class="pl-share-row">
                        <button class="pl-share-btn wa" onclick="shareWA()" title="WhatsApp"><i class="fab fa-whatsapp"></i></button>
                        <button class="pl-share-btn fb" onclick="shareFB()" title="Facebook"><i class="fab fa-facebook-f"></i></button>
                        <button class="pl-share-btn tw" onclick="shareTW()" title="Twitter / X"><i class="fab fa-x-twitter"></i></button>
                        <button class="pl-share-btn cp" onclick="copyLink()" title="Copia link"><i class="fas fa-link"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="lp-footer" id="lpFooter">
        &copy; 2024 <a href="/public/index.html">CDM86</a> â€” Promozioni esclusive per te
    </footer>

    <script>
        let supabaseClient;
        const urlParams = new URLSearchParams(window.location.search);
        const slug = (window.location.pathname.split('/promo/')[1] || '').replace(/\/$/, '') || urlParams.get('slug');

        if (typeof CDM86_CONFIG !== 'undefined' && CDM86_CONFIG.supabase) {
            supabaseClient = supabase.createClient(CDM86_CONFIG.supabase.url, CDM86_CONFIG.supabase.anonKey);
        }

        // â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function hideLoading() {
            const ls = document.getElementById('loadingScreen');
            ls.style.opacity = '0';
            setTimeout(() => ls.style.display = 'none', 400);
        }

        function showNav() {
            document.getElementById('lpNav').style.display = 'flex';
            document.getElementById('lpFooter').style.display = 'block';
        }

        function showError(title, msg) {
            hideLoading();
            document.getElementById('errTitle').textContent = title;
            document.getElementById('errMsg').textContent = msg;
            document.getElementById('errorScreen').classList.add('show');
        }

        // â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadPromo() {
            if (!slug) { showError('Promo non trovata', 'URL non valido.'); return; }
            if (!supabaseClient) { showError('Errore configurazione', 'Database non raggiungibile.'); return; }

            try {
                // 1ï¸âƒ£ organization_pages (landing builder)
                const { data: orgPage } = await supabaseClient
                    .from('organization_pages')
                    .select('*')
                    .or(`slug.eq.${slug},landing_slug.eq.${slug}`)
                    .eq('card_published', true)
                    .maybeSingle();

                if (orgPage) { renderOrgLanding(orgPage); return; }

                // 2ï¸âƒ£ promotions table (promo-creator)
                const { data: promo, error } = await supabaseClient
                    .from('promotions')
                    .select('*')
                    .eq('landing_slug', slug)
                    .eq('is_active', true)
                    .maybeSingle();

                if (promo) { renderPromo(promo); return; }

                showError('Promozione non trovata', 'Questa offerta non Ã¨ piÃ¹ disponibile o il link non Ã¨ corretto.');

            } catch (err) {
                console.error('loadPromo error:', err);
                showError('Errore di caricamento', err.message || 'Riprova piÃ¹ tardi.');
            }
        }

        // â”€â”€ Render: Org Landing (landing builder) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderOrgLanding(page) {
            showNav();
            const pageData = page.page_data || {};
            const cardData = page.card_data || {};
            const title = cardData.title || page.page_title || 'Offerta';

            // Update <title> and OG tags
            document.getElementById('pageTitle').textContent = title + ' â€” CDM86';
            document.getElementById('ogTitle').setAttribute('content', title);
            document.getElementById('ogDescription').setAttribute('content', cardData.description || page.page_description || '');
            if (cardData.image) document.getElementById('ogImage').setAttribute('content', cardData.image);

            if (page.content) {
                // â”€â”€ Full HTML snapshot from builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const wrap = document.getElementById('orgLandingWrap');
                const sectionsDiv = document.getElementById('orgLandingSections');
                sectionsDiv.innerHTML = page.content;

                // Append social bar if not already in content
                const socialLinks = page.social_links || cardData.socialLinks || {};
                const hasSocial = sectionsDiv.querySelector('.landing-social-bar');
                if (!hasSocial) {
                    const socialHtml = buildSocialBarHtml(socialLinks);
                    if (socialHtml) sectionsDiv.insertAdjacentHTML('beforeend', socialHtml);
                }

                wrap.style.display = 'block';
                hideLoading();

            } else {
                // â”€â”€ Fallback: render from card_data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                renderOrgFallback(page, cardData, pageData);
            }
        }

        function renderOrgFallback(page, cardData, pageData) {
            const socialLinks = page.social_links || cardData.socialLinks || {};
            const ctaLink = cardData.ctaLinkHero || pageData.ctaLinkHero || socialLinks.whatsapp || socialLinks.website || null;
            const title = cardData.title || page.page_title || 'Offerta Speciale';
            const desc = cardData.description || page.page_description || '';

            const socialHtml = buildSocialIconsHtml(socialLinks);

            document.getElementById('orgFallbackCard').innerHTML = `
                ${cardData.image ? `<img src="${cardData.image}" alt="${title}" class="of-image">` : `
                    <div style="width:100%;height:240px;background:linear-gradient(135deg,#c7d2fe,#818cf8);display:flex;align-items:center;justify-content:center;font-size:4rem;">ğŸ·ï¸</div>
                `}
                <div class="of-body">
                    <div class="pl-badge" style="display:inline-flex;margin-bottom:1.2rem;">${cardData.badge || 'â­ OFFERTA'}</div>
                    <h1 class="of-title">${title}</h1>
                    <p class="of-desc">${desc}</p>
                    ${ctaLink ? `
                        <a href="${ctaLink}" class="of-cta" target="_blank" rel="noopener">
                            <i class="fas fa-arrow-right"></i> ${cardData.ctaText || 'SCOPRI DI PIÃ™'}
                        </a>
                    ` : ''}
                    ${socialHtml ? `
                        <div class="of-socials">
                            <div class="of-socials-title">Seguici sui social</div>
                            <div class="of-socials-row">${socialHtml}</div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('orgFallbackWrap').style.display = 'block';
            hideLoading();
        }

        // â”€â”€ Render: Standard Promo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderPromo(promo) {
            document.getElementById('pageTitle').textContent = promo.title + ' â€” CDM86';
            document.getElementById('ogTitle').setAttribute('content', promo.title);
            document.getElementById('ogDescription').setAttribute('content', promo.description || '');
            if (promo.image_url) document.getElementById('ogImage').setAttribute('content', promo.image_url);

            const savings = promo.original_price && promo.price
                ? Math.round(((promo.original_price - promo.price) / promo.original_price) * 100) : 0;

            // Hero image
            const imgWrap = document.getElementById('plHeroImageWrap');
            imgWrap.innerHTML = promo.image_url
                ? `<img src="${promo.image_url}" alt="${promo.title}" class="pl-hero-image" onerror="this.parentElement.innerHTML='<div class=\\'pl-hero-image-placeholder\\'>ğŸ·ï¸</div>'">`
                : `<div class="pl-hero-image-placeholder">ğŸ·ï¸</div>`;

            document.getElementById('plBadge').textContent = getCategoryLabel(promo.category);
            document.getElementById('plTitle').textContent = promo.title;
            document.getElementById('plDesc').textContent = promo.description || '';

            // Pricing
            const pricingEl = document.getElementById('plPricing');
            if (promo.price != null) {
                pricingEl.innerHTML = `
                    <div class="pl-price">â‚¬${Number(promo.price).toFixed(2)}</div>
                    ${promo.original_price ? `<div class="pl-original">â‚¬${Number(promo.original_price).toFixed(2)}</div>` : ''}
                `;
            } else {
                pricingEl.style.display = 'none';
            }

            // Savings badge
            const savingsEl = document.getElementById('plSavings');
            if (savings > 0) {
                savingsEl.innerHTML = `<div class="pl-savings">ğŸ‰ Risparmi il ${savings}%</div>`;
            }

            // CTA
            const ctaBtn = document.getElementById('plCtaBtn');
            ctaBtn.innerHTML = `<i class="fas fa-gift"></i> ${promo.cta_text || 'RISCATTA ORA'}`;
            ctaBtn.onclick = () => redeemPromo(promo.id);

            showNav();
            document.getElementById('promoLandingWrap').style.display = 'block';
            hideLoading();
        }

        // â”€â”€ Social helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const SOCIAL_DEFS = [
            { key: 'facebook',  icon: 'fab fa-facebook-f',  color: '#1877f2', label: 'Facebook' },
            { key: 'instagram', icon: 'fab fa-instagram',   color: '#e1306c', label: 'Instagram' },
            { key: 'twitter',   icon: 'fab fa-x-twitter',   color: '#000',    label: 'X / Twitter' },
            { key: 'linkedin',  icon: 'fab fa-linkedin-in', color: '#0a66c2', label: 'LinkedIn' },
            { key: 'tiktok',    icon: 'fab fa-tiktok',      color: '#010101', label: 'TikTok' },
            { key: 'whatsapp',  icon: 'fab fa-whatsapp',    color: '#25d366', label: 'WhatsApp' },
            { key: 'website',   icon: 'fas fa-globe',       color: '#667eea', label: 'Sito Web' }
        ];

        function buildSocialIconsHtml(links) {
            if (!links) return '';
            return SOCIAL_DEFS
                .filter(d => links[d.key])
                .map(d => `
                    <a href="${links[d.key]}" target="_blank" rel="noopener" title="${d.label}" class="of-social-link" style="background:${d.color};">
                        <i class="${d.icon}"></i>
                    </a>
                `).join('');
        }

        function buildSocialBarHtml(links) {
            if (!links) return '';
            const active = SOCIAL_DEFS.filter(d => links[d.key]);
            if (!active.length) return '';
            return `
                <div class="landing-social-bar" style="background:#1e293b;padding:3rem 2rem;text-align:center;">
                    <h3 style="color:white;margin-bottom:1.5rem;font-size:1.2rem;font-family:Inter,sans-serif;">Seguici sui Social</h3>
                    <div class="landing-social-icons" style="display:flex;justify-content:center;gap:1rem;flex-wrap:wrap;">
                        ${active.map(d => `
                            <a href="${links[d.key]}" class="landing-social-link" style="background:${d.color};width:52px;height:52px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:1.3rem;color:white;text-decoration:none;" target="_blank" rel="noopener" title="${d.label}">
                                <i class="${d.icon}"></i>
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // â”€â”€ Category labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getCategoryLabel(cat) {
            const map = {
                food: 'ğŸ• Cibo & Drink', beauty: 'ğŸ’‡ Bellezza',
                wellness: 'ğŸ§˜ Benessere', shopping: 'ğŸ›ï¸ Shopping',
                entertainment: 'ğŸ­ Intrattenimento', travel: 'âœˆï¸ Viaggi'
            };
            return map[cat] || 'ğŸ Offerta Speciale';
        }

        // â”€â”€ Redeem â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function redeemPromo(promoId) {
            alert('ğŸ‰ Promo riscattata! Ti contatteremo presto.');
            if (supabaseClient) {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session) {
                        await supabaseClient.from('promotion_redemptions').insert({
                            promotion_id: promoId,
                            user_id: session.user.id
                        });
                    }
                } catch (e) { console.error('Redeem log error:', e); }
            }
        }

        // â”€â”€ Share â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function shareWA() {
            const t = encodeURIComponent(`ğŸ Guarda questa offerta su CDM86!\n${window.location.href}`);
            window.open(`https://wa.me/?text=${t}`, '_blank');
        }
        function shareFB() {
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank');
        }
        function shareTW() {
            const t = encodeURIComponent(document.title);
            window.open(`https://twitter.com/intent/tweet?text=${t}&url=${encodeURIComponent(window.location.href)}`, '_blank');
        }
        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const btn = document.querySelector('.pl-share-btn.cp');
                if (btn) { btn.innerHTML = '<i class="fas fa-check"></i>'; setTimeout(() => btn.innerHTML = '<i class="fas fa-link"></i>', 2000); }
            });
        }

        window.addEventListener('DOMContentLoaded', loadPromo);
    </script>
</body>
</html>
