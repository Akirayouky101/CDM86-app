/**
 * CAP GeoData - Database geografico dei CAP italiani
 * Contiene coordinate (lat/lng) per i principali CAP italiani
 * Fonte: OpenStreetMap / GeoNames
 */

window.CAPGeoData = {
    // ROMA (00100-00199)
    '00100': { lat: 41.9028, lng: 12.4964, city: 'Roma', area: 'Centro Storico' },
    '00101': { lat: 41.8919, lng: 12.4922, city: 'Roma', area: 'Esquilino' },
    '00118': { lat: 41.8538, lng: 12.4583, city: 'Roma', area: 'Appio Latino' },
    '00119': { lat: 41.8333, lng: 12.5167, city: 'Roma', area: 'Cinecittà' },
    '00120': { lat: 41.8000, lng: 12.2333, city: 'Fiumicino', area: 'Aeroporto' },
    '00121': { lat: 41.7333, lng: 12.2667, city: 'Lido di Ostia', area: 'Litorale' },
    '00122': { lat: 41.7167, lng: 12.2833, city: 'Ostia', area: 'Centro' },
    '00123': { lat: 41.8833, lng: 12.3833, city: 'Roma', area: 'Primavalle' },
    '00124': { lat: 41.7500, lng: 12.2167, city: 'Ostia Antica', area: '' },
    '00125': { lat: 41.7667, lng: 12.3000, city: 'Acilia', area: '' },
    '00126': { lat: 41.7833, lng: 12.3500, city: 'Casal Palocco', area: '' },
    '00127': { lat: 41.8167, lng: 12.5500, city: 'Roma', area: 'Ciampino' },
    '00128': { lat: 41.8500, lng: 12.5833, city: 'Roma', area: 'EUR' },
    '00131': { lat: 41.9167, lng: 12.5500, city: 'Roma', area: 'Tiburtina' },
    '00132': { lat: 41.9500, lng: 12.5833, city: 'Roma', area: 'Settecamini' },
    '00133': { lat: 41.8833, lng: 12.6167, city: 'Roma', area: 'Castelverde' },
    '00134': { lat: 41.9833, lng: 12.3667, city: 'Roma', area: 'La Storta' },
    '00135': { lat: 41.9500, lng: 12.4500, city: 'Roma', area: 'Trionfale' },
    '00136': { lat: 41.9333, lng: 12.4333, city: 'Roma', area: 'Aurelio' },
    '00137': { lat: 41.9167, lng: 12.5833, city: 'Roma', area: 'Prenestino' },
    '00138': { lat: 41.9500, lng: 12.5167, city: 'Roma', area: 'Montesacro' },
    '00139': { lat: 41.9333, lng: 12.5667, city: 'Roma', area: 'Ponte Mammolo' },
    '00141': { lat: 41.9167, lng: 12.5333, city: 'Roma', area: 'Nomentano' },
    '00142': { lat: 41.8333, lng: 12.4667, city: 'Roma', area: 'EUR' },
    '00143': { lat: 41.8167, lng: 12.4833, city: 'Roma', area: 'Ardeatino' },
    '00144': { lat: 41.8000, lng: 12.4500, city: 'Roma', area: 'EUR Laurentino' },
    '00145': { lat: 41.8500, lng: 12.4667, city: 'Roma', area: 'Garbatella' },
    '00146': { lat: 41.8667, lng: 12.4500, city: 'Roma', area: 'San Paolo' },
    '00147': { lat: 41.8500, lng: 12.4333, city: 'Roma', area: 'Ostiense' },
    '00148': { lat: 41.7833, lng: 12.4167, city: 'Roma', area: 'Valleranello' },
    '00149': { lat: 41.8833, lng: 12.4167, city: 'Roma', area: 'Casetta Mattei' },
    '00151': { lat: 41.8833, lng: 12.4333, city: 'Roma', area: 'Portuense' },
    '00152': { lat: 41.8667, lng: 12.4667, city: 'Roma', area: 'Testaccio' },
    '00153': { lat: 41.8833, lng: 12.4833, city: 'Roma', area: 'Trastevere' },
    '00154': { lat: 41.8667, lng: 12.5000, city: 'Roma', area: 'San Giovanni' },
    '00155': { lat: 41.8833, lng: 12.5333, city: 'Roma', area: 'Prenestino' },
    '00156': { lat: 41.9000, lng: 12.5500, city: 'Roma', area: 'Tiburtino' },
    '00157': { lat: 41.9333, lng: 12.5333, city: 'Roma', area: 'Montesacro Alto' },
    '00158': { lat: 41.8500, lng: 12.5333, city: 'Roma', area: 'Quadraro' },
    '00159': { lat: 41.9000, lng: 12.5667, city: 'Roma', area: 'Pietralata' },
    '00161': { lat: 41.9167, lng: 12.5167, city: 'Roma', area: 'Trieste' },
    '00162': { lat: 41.9167, lng: 12.5333, city: 'Roma', area: 'Nomentano' },
    '00163': { lat: 41.9500, lng: 12.4333, city: 'Roma', area: 'Ottavia' },
    '00164': { lat: 41.9000, lng: 12.4000, city: 'Roma', area: 'Boccea' },
    '00165': { lat: 41.9000, lng: 12.4500, city: 'Roma', area: 'Prati' },
    '00166': { lat: 41.9167, lng: 12.4167, city: 'Roma', area: 'Monte Mario' },
    '00167': { lat: 41.9333, lng: 12.4167, city: 'Roma', area: 'Monte Mario Alto' },
    '00168': { lat: 41.9500, lng: 12.4167, city: 'Roma', area: 'La Giustiniana' },
    '00169': { lat: 41.8667, lng: 12.5500, city: 'Roma', area: 'Torre Angela' },
    '00171': { lat: 41.8833, lng: 12.5500, city: 'Roma', area: 'Centocelle' },
    '00172': { lat: 41.8833, lng: 12.5667, city: 'Roma', area: 'Alessandrino' },
    '00173': { lat: 41.8500, lng: 12.5667, city: 'Roma', area: 'Giardinetti' },
    '00174': { lat: 41.8167, lng: 12.5833, city: 'Roma', area: 'Torre Maura' },
    '00175': { lat: 41.8667, lng: 12.5333, city: 'Roma', area: 'Torre Spaccata' },
    '00176': { lat: 41.8833, lng: 12.5167, city: 'Roma', area: 'Torpignattara' },
    '00177': { lat: 41.8667, lng: 12.5667, city: 'Roma', area: 'Cinecittà' },
    '00178': { lat: 41.8500, lng: 12.5500, city: 'Roma', area: 'Quadraro' },
    '00179': { lat: 41.8333, lng: 12.5333, city: 'Roma', area: 'Tuscolano' },
    '00181': { lat: 41.8667, lng: 12.5167, city: 'Roma', area: 'Appio Latino' },
    '00182': { lat: 41.8833, lng: 12.5000, city: 'Roma', area: 'Appio' },
    '00183': { lat: 41.8917, lng: 12.5050, city: 'Roma', area: 'San Giovanni' },
    '00184': { lat: 41.8981, lng: 12.4839, city: 'Roma', area: 'Monti' },
    '00185': { lat: 41.8983, lng: 12.5067, city: 'Roma', area: 'Esquilino' },
    '00186': { lat: 41.8986, lng: 12.4730, city: 'Roma', area: 'Campo Marzio' },
    '00187': { lat: 41.9067, lng: 12.4956, city: 'Roma', area: 'Ludovisi' },
    '00188': { lat: 41.9667, lng: 12.4667, city: 'Roma', area: 'Labaro' },
    '00189': { lat: 41.9833, lng: 12.5000, city: 'Roma', area: 'Prima Porta' },
    '00191': { lat: 41.9167, lng: 12.4667, city: 'Roma', area: 'Parioli' },
    '00192': { lat: 41.9028, lng: 12.4567, city: 'Roma', area: 'Vaticano' },
    '00193': { lat: 41.9000, lng: 12.4667, city: 'Roma', area: 'Prati' },
    '00194': { lat: 41.9139, lng: 12.4419, city: 'Roma', area: 'Città del Vaticano' },
    '00195': { lat: 41.9167, lng: 12.4500, city: 'Roma', area: 'Prati Fiscali' },
    '00196': { lat: 41.9167, lng: 12.4833, city: 'Roma', area: 'Flaminio' },
    '00197': { lat: 41.9333, lng: 12.4833, city: 'Roma', area: 'Parioli' },
    '00198': { lat: 41.9167, lng: 12.4917, city: 'Roma', area: 'Salario' },
    '00199': { lat: 41.9333, lng: 12.5000, city: 'Roma', area: 'Monte Sacro' },

    // MILANO (20100-20199)
    '20100': { lat: 45.4642, lng: 9.1900, city: 'Milano', area: 'Centro' },
    '20121': { lat: 45.4654, lng: 9.1859, city: 'Milano', area: 'Duomo' },
    '20122': { lat: 45.4642, lng: 9.1900, city: 'Milano', area: 'Porta Romana' },
    '20123': { lat: 45.4654, lng: 9.1777, city: 'Milano', area: 'Magenta' },
    '20124': { lat: 45.4773, lng: 9.1815, city: 'Milano', area: 'Porta Nuova' },
    '20125': { lat: 45.4833, lng: 9.2167, city: 'Milano', area: 'Centrale' },
    '20126': { lat: 45.5333, lng: 9.1000, city: 'Milano', area: 'Bollate' },
    '20127': { lat: 45.4833, lng: 9.2333, city: 'Milano', area: 'Loreto' },
    '20128': { lat: 45.5000, lng: 9.2500, city: 'Milano', area: 'Greco' },
    '20129': { lat: 45.4833, lng: 9.2500, city: 'Milano', area: 'Città Studi' },
    '20131': { lat: 45.5000, lng: 9.2000, city: 'Milano', area: 'Niguarda' },
    '20132': { lat: 45.5167, lng: 9.2333, city: 'Milano', area: 'Sesto San Giovanni' },
    '20133': { lat: 45.4833, lng: 9.2167, city: 'Milano', area: 'Lambrate' },
    '20134': { lat: 45.4500, lng: 9.2333, city: 'Milano', area: 'Forlanini' },
    '20135': { lat: 45.4667, lng: 9.1500, city: 'Milano', area: 'Sempione' },
    '20136': { lat: 45.4500, lng: 9.1667, city: 'Milano', area: 'Bande Nere' },
    '20137': { lat: 45.4500, lng: 9.2000, city: 'Milano', area: 'Monlué' },
    '20138': { lat: 45.4667, lng: 9.1333, city: 'Milano', area: 'QT8' },
    '20139': { lat: 45.5167, lng: 9.2167, city: 'Milano', area: 'Niguarda Nord' },
    '20141': { lat: 45.4333, lng: 9.1333, city: 'Milano', area: 'Baggio' },
    '20142': { lat: 45.4333, lng: 9.1667, city: 'Milano', area: 'Giambellino' },
    '20143': { lat: 45.4333, lng: 9.1500, city: 'Milano', area: 'Barona' },
    '20144': { lat: 45.4500, lng: 9.1500, city: 'Milano', area: 'Lorenteggio' },
    '20145': { lat: 45.4500, lng: 9.1333, city: 'Milano', area: 'San Siro' },
    '20146': { lat: 45.4833, lng: 9.1333, city: 'Milano', area: 'Gallaratese' },
    '20147': { lat: 45.5000, lng: 9.1333, city: 'Milano', area: 'Certosa' },
    '20148': { lat: 45.5333, lng: 9.1333, city: 'Milano', area: 'Quarto Oggiaro' },
    '20149': { lat: 45.4833, lng: 9.1167, city: 'Milano', area: 'Lampugnano' },
    '20151': { lat: 45.4667, lng: 9.1167, city: 'Milano', area: 'Trenno' },
    '20152': { lat: 45.4500, lng: 9.1167, city: 'Milano', area: 'Baggio Ovest' },
    '20153': { lat: 45.4667, lng: 9.1667, city: 'Milano', area: 'Sarpi' },
    '20154': { lat: 45.4833, lng: 9.1667, city: 'Milano', area: 'Isola' },
    '20155': { lat: 45.5000, lng: 9.1667, city: 'Milano', area: 'Dergano' },
    '20156': { lat: 45.5167, lng: 9.1833, city: 'Milano', area: 'Affori' },
    '20157': { lat: 45.5333, lng: 9.2000, city: 'Milano', area: 'Bovisasca' },
    '20158': { lat: 45.5500, lng: 9.2167, city: 'Milano', area: 'Bicocca' },
    '20159': { lat: 45.5167, lng: 9.2000, city: 'Milano', area: 'Niguarda' },
    '20161': { lat: 45.5000, lng: 9.2333, city: 'Milano', area: 'Sesto San Giovanni' },
    '20162': { lat: 45.5333, lng: 9.2333, city: 'Milano', area: 'Cinisello Balsamo' },

    // NAPOLI (80100-80199)
    '80100': { lat: 40.8518, lng: 14.2681, city: 'Napoli', area: 'Centro' },
    '80121': { lat: 40.8359, lng: 14.2489, city: 'Napoli', area: 'Chiaia' },
    '80122': { lat: 40.8333, lng: 14.2500, city: 'Napoli', area: 'Mergellina' },
    '80123': { lat: 40.8300, lng: 14.2167, city: 'Napoli', area: 'Posillipo' },
    '80124': { lat: 40.8167, lng: 14.2000, city: 'Napoli', area: 'Bagnoli' },
    '80125': { lat: 40.8500, lng: 14.2167, city: 'Napoli', area: 'Fuorigrotta' },
    '80126': { lat: 40.8500, lng: 14.2333, city: 'Napoli', area: 'Soccavo' },
    '80127': { lat: 40.8667, lng: 14.2333, city: 'Napoli', area: 'Pianura' },
    '80128': { lat: 40.8833, lng: 14.2167, city: 'Napoli', area: 'Chiaiano' },
    '80129': { lat: 40.8833, lng: 14.2500, city: 'Napoli', area: 'Piscinola' },
    '80131': { lat: 40.8667, lng: 14.2667, city: 'Napoli', area: 'Scampia' },
    '80132': { lat: 40.8833, lng: 14.2833, city: 'Napoli', area: 'Secondigliano' },
    '80133': { lat: 40.8500, lng: 14.2833, city: 'Napoli', area: 'Miano' },
    '80134': { lat: 40.8389, lng: 14.2528, city: 'Napoli', area: 'Porto' },
    '80135': { lat: 40.8500, lng: 14.2500, city: 'Napoli', area: 'Vomero' },
    '80136': { lat: 40.8667, lng: 14.2500, city: 'Napoli', area: 'Arenella' },
    '80137': { lat: 40.8500, lng: 14.2667, city: 'Napoli', area: 'Capodimonte' },
    '80138': { lat: 40.8667, lng: 14.2833, city: 'Napoli', area: 'Colli Aminei' },
    '80139': { lat: 40.8500, lng: 14.3000, city: 'Napoli', area: 'Poggioreale' },
    '80141': { lat: 40.8333, lng: 14.3000, city: 'Napoli', area: 'Barra' },
    '80142': { lat: 40.8333, lng: 14.3167, city: 'Napoli', area: 'San Giovanni a Teduccio' },
    '80143': { lat: 40.8167, lng: 14.3167, city: 'Napoli', area: 'Ponticelli' },
    '80144': { lat: 40.8500, lng: 14.3167, city: 'Napoli', area: 'Zona Industriale' },
    '80145': { lat: 40.8500, lng: 14.2833, city: 'Napoli', area: 'Stella' },
    '80146': { lat: 40.8667, lng: 14.3000, city: 'Napoli', area: 'Doganella' },
    '80147': { lat: 40.8333, lng: 14.2833, city: 'Napoli', area: 'Mercato' },

    // TORINO (10100-10199)
    '10100': { lat: 45.0703, lng: 7.6869, city: 'Torino', area: 'Centro' },
    '10121': { lat: 45.0625, lng: 7.6808, city: 'Torino', area: 'Centro' },
    '10122': { lat: 45.0667, lng: 7.6833, city: 'Torino', area: 'Crocetta' },
    '10123': { lat: 45.0703, lng: 7.6869, city: 'Torino', area: 'San Salvario' },
    '10124': { lat: 45.0500, lng: 7.6667, city: 'Torino', area: 'Nizza Millefonti' },
    '10125': { lat: 45.0333, lng: 7.6500, city: 'Torino', area: 'Mirafiori Sud' },
    '10126': { lat: 45.0333, lng: 7.6833, city: 'Torino', area: 'Lingotto' },
    '10127': { lat: 45.0500, lng: 7.7000, city: 'Torino', area: 'Madonna del Pilone' },
    '10128': { lat: 45.0833, lng: 7.7167, city: 'Torino', area: 'Borgo Po' },
    '10129': { lat: 45.1000, lng: 7.7333, city: 'Torino', area: 'Vanchiglia' },
    '10131': { lat: 45.0833, lng: 7.7000, city: 'Torino', area: 'Borgo Rossini' },
    '10132': { lat: 45.1000, lng: 7.7000, city: 'Torino', area: 'Barriera di Milano' },
    '10133': { lat: 45.1167, lng: 7.7000, city: 'Torino', area: 'Rebaudengo' },
    '10134': { lat: 45.1167, lng: 7.6667, city: 'Torino', area: 'Vallette' },
    '10135': { lat: 45.1000, lng: 7.6500, city: 'Torino', area: 'Madonna di Campagna' },
    '10136': { lat: 45.0833, lng: 7.6333, city: 'Torino', area: 'Santa Rita' },
    '10137': { lat: 45.0667, lng: 7.6333, city: 'Torino', area: 'Mirafiori Nord' },
    '10138': { lat: 45.0500, lng: 7.6333, city: 'Torino', area: 'Mirafiori Sud' },
    '10139': { lat: 45.0833, lng: 7.6667, city: 'Torino', area: 'San Donato' },
    '10141': { lat: 45.0667, lng: 7.7167, city: 'Torino', area: 'San Salvario' },
    '10142': { lat: 45.0500, lng: 7.7167, city: 'Torino', area: 'Santa Rita' },
    '10143': { lat: 45.0333, lng: 7.7167, city: 'Torino', area: 'Mirafiori' },
    '10144': { lat: 45.0167, lng: 7.6667, city: 'Torino', area: 'Mirafiori Sud' },
    '10145': { lat: 45.0667, lng: 7.6500, city: 'Torino', area: 'Pozzo Strada' },
    '10146': { lat: 45.0833, lng: 7.6500, city: 'Torino', area: 'Cenisia' },
    '10147': { lat: 45.1000, lng: 7.6333, city: 'Torino', area: 'Borgata Lesna' },
    '10148': { lat: 45.1167, lng: 7.6333, city: 'Torino', area: 'Lucento' },
    '10149': { lat: 45.1333, lng: 7.6500, city: 'Torino', area: 'Venaria' },
    '10151': { lat: 45.1000, lng: 7.6667, city: 'Torino', area: 'Campidoglio' },
    '10152': { lat: 45.1167, lng: 7.6833, city: 'Torino', area: 'Regio Parco' },
    '10153': { lat: 45.1167, lng: 7.7167, city: 'Torino', area: 'Falchera' },
    '10154': { lat: 45.1333, lng: 7.7167, city: 'Torino', area: 'Settimo' },
    '10155': { lat: 45.1000, lng: 7.7500, city: 'Torino', area: 'Sassi' },
    '10156': { lat: 45.0667, lng: 7.7500, city: 'Torino', area: 'Precollina' }
};

/**
 * Ottiene le coordinate per un CAP
 * @param {string} cap - Codice postale (5 cifre)
 * @returns {object|null} - {lat, lng, city, area} o null se non trovato
 */
window.getCAPCoordinates = function(cap) {
    return window.CAPGeoData[cap] || null;
};

/**
 * Calcola il centro geografico di un array di CAP
 * @param {Array<string>} capList - Array di CAP
 * @returns {object} - {lat, lng, count} centro e numero di CAP trovati
 */
window.calculateCAPCenter = function(capList) {
    let totalLat = 0;
    let totalLng = 0;
    let count = 0;

    capList.forEach(cap => {
        const coords = window.getCAPCoordinates(cap);
        if (coords) {
            totalLat += coords.lat;
            totalLng += coords.lng;
            count++;
        }
    });

    if (count === 0) {
        // Default to Italy center if no CAP found
        return { lat: 41.8719, lng: 12.5674, count: 0 };
    }

    return {
        lat: totalLat / count,
        lng: totalLng / count,
        count: count
    };
};

/**
 * Cerca CAP per città
 * @param {string} city - Nome della città
 * @returns {Array<string>} - Array di CAP per quella città
 */
window.searchCAPByCity = function(city) {
    const results = [];
    for (const [cap, data] of Object.entries(window.CAPGeoData)) {
        if (data.city.toLowerCase().includes(city.toLowerCase())) {
            results.push(cap);
        }
    }
    return results;
};

console.log('✅ CAP GeoData loaded:', Object.keys(window.CAPGeoData).length, 'CAP codes');
